"use strict";var _now=Date.now||function(){return(new Date).getTime()};function debounce(n,s){var r=null,o=_now(),a=function(e,t){n.apply(e,t),o=_now(),r=setTimeout(function(){r=null},s)};return s=s||400,function(){var e=this,t=arguments;!r||_now()-o>s?a(e,t):(clearTimeout(r),r=setTimeout(function(){a(e,t)},s))}}var arrayShift=[].shift,isArray=function(e){return e instanceof Array},isObject=function(e){return"object"==typeof e&&null!==e};function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _find(e,t,n){for(var s=0,r=e.length;s<r;s++)if(t.call(n,e[s],s))return e[s]}function _removeItem(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}function eventMethods(s){var r={},o={};return(s=s||{}).on=function(e,t){return r[e]=r[e]||[],r[e].push(t),s},s.once=function(e,t){return o[e]=o[e]||[],o[e].push(t),s},s.off=function(e,t){return r[e]&&_removeItem(r[e],t),s},s.emit=function(e,t,n){return r[e]&&r[e].forEach(function(e){e.apply(n,t)}),o[e]&&o[e].splice(0).forEach(function(e){e.apply(n,t)}),s},s}function GooglePlaceTypeahead(e){this.options=e||{},this.loading_listeners=[]}var callback_num=0;function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var s={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(s.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),s}GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),s="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[s]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+s,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},GooglePlaceTypeahead.prototype.getPredictions=function(e,s,r){if(e)return this.load(function(n){n.service.autocomplete.getPlacePredictions(_merge({},n.options,{input:e,sessionToken:n.options.session_token}),function(e,t){t==n.predictions_OK?s instanceof Function&&s(e):r instanceof Function&&r(t)})});s instanceof Function&&s([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,s=0,r=e.description,o="";if(!e.matched_substrings)return e.formatted_address;for(var a=0,i=e.matched_substrings.length;a<i;a++)t=e.matched_substrings[a].offset,n=e.matched_substrings[a].length,o+=r.substr(s,t-s).replace(/^ | $/g,"&nbsp;"),o+="<strong>"+r.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",s=t+n;return o+=r.substr(s)};var _place_fields="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);GooglePlaceTypeahead.prototype.getAddress=function(n,s,r){this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||_place_fields},function(e,t){"OK"===t?s instanceof Function&&s(_parsePlace(e,n)):r instanceof Function&&r(t)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var arrayShift$1=Array.prototype.shift;function __extractProps(e,n){return(e||"").replace(/#([^\s.]+)/,function(e,t){return n.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return n.className=n.className?n.className+" "+t:t,""})}function __create(e,t,n,s){var r,o=document.createElement(e||"div");if(t)for(r in t)o.setAttribute(r,t[r]);for(r in n)o[r]=n[r];return s&&s.forEach(function(e){o.appendChild(e)}),o}function _create(){var e,t,n,s=arrayShift$1.call(arguments);return"string"!=typeof s?(e=s,s=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},__create(s=__extractProps(s,t),e,t,n)}var classListEnabled="classList"in document.documentElement,hasClass=classListEnabled?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},addClass=classListEnabled?function(e,t){e.classList.add(t)}:function(e,t){hasClass(e,t)||(e.className+=" "+t)},removeClass=classListEnabled?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function _onClick(e,t,n){return e.addEventListener("click",t,n)}function _offClick(e,t,n){return e.removeEventListener("click",t,n)}function _onInput(e,t,n){return e.addEventListener("input",t,n)}function _onFocus(e,t,n){return e.addEventListener("focus",t,n)}function _onBlur(e,t,n){return e.addEventListener("blur",t,n)}function commaIf(e){return e?", "+e:""}function address2Search(e,t){if(!e)return"";var n=e.sublocality||e.locality||e.city;return e.street+(commaIf(e.street_number)||(t?", ":""))+commaIf(n!==e.street&&n)}function formattedAddress(e){return e?e.street+commaIf(e.street_number)+commaIf(e.postcode+" "+e.locality)+commaIf(e.province)+commaIf(e.region)+commaIf(e.country):""}function AddressTypeahead(e){this.options=e||{},this.options.google&&(this.provider=new GooglePlaceTypeahead(this.options.google).load())}AddressTypeahead.prototype.bind=function(o,e){var t=eventMethods({}),a=[],i={},c=(e=e||{}).focus_root||document,l=this.provider,n=!1,s=!1;"string"==typeof o&&(o=c.querySelector(o));var r,d=e.predictions_parent?"string"==typeof e.predictions_parent?c.querySelector(e.predictions_parent):e.predictions_parent:o.parentElement,u=_create(".-predictions-list"),f=_create(".-predictions-list._custom-list"),p=_create(".-predictions-footer"),m=_create(".apz-address-typeahead-predictions",[u,f]);function _(){var e=o.value&&o.value.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return e?e[1]:null}function g(){t.emit("change",[o.value,i.address,_()])}function h(){t.emit("blur",[o.value,i.address,_()])}function v(){n||(!i.address||i.address.street_number||_()||(C([]),o.value=address2Search(i.address,!0)),m.style.display="none",h(),_offClick(document,y,!0))}function y(e){var t=e.target;if(c.activeElement!==o){for(;t&&t!==document.body;){if(t===m||t===o)return;t=t.parentElement}v(),s=!1}}function b(e,t){var n=_create(".-prediction._custom"),s=function(){w(),C([]),addClass(n,"_selected"),i.address=e,o.value=address2Search(e),v()};return n.innerHTML=address2Search(e),_onClick(n,s),t&&s(),n}function C(e){var t,n,s,r=u.children;if(e&&(a=e),toggleClass(m,"_has_predictions",a.length),a.length>r.length)for(t=0,n=a.length-r.length;t<n;t++)u.appendChild((void 0,_onClick(s=_create(".-prediction"),function(){E(this.getAttribute("data-predition"),function(){var e=_();return i.address&&i.address.street_number?e&&Number(e)!==Number(i.address.street_number)?(c.activeElement!==o&&o.focus(),void h()):void v():(c.activeElement!==o&&o.focus(),void h())})}),s));for(t=0,n=a.length;t<n;t++)r[t].innerHTML=l.getPredictionHTML(a[t])||address2Search(a[t]),r[t].setAttribute("data-predition",a[t].id),toggleClass(r[t],"_custom","custom"===a[t].place);if(a.length<r.length)for(;r[a.length];)u.removeChild(r[a.length])}function E(t,n){"string"==typeof t&&(t=_find(a,function(e){return e.id===t})),t&&(w(),_find(u.children,function(e){if(e.getAttribute("data-predition")===t.id)return addClass(e,"_selected"),!0}),i.prediction=t,!1!==n?l.getAddress(t,function(e){t===i.prediction&&(i.address=e,c.activeElement===o||!i.address||i.address.street_number||_()||(o.value=address2Search(e,!0)),n instanceof Function&&n(),g())}):g())}function w(){var e,t,n=u.children;for(e=0,t=n.length;e<t;e++)removeClass(n[e],"_selected");for(e=0,t=(n=f.children).length;e<t;e++)removeClass(n[e],"_selected");delete i.prediction}function L(){if(i.address&&i.address.custom&&w(),delete i.address,!o.value)return C([]),w(),void g();l.getPredictions(o.value,function(e){C(e),a[0]&&E(a[0])})}m.style.display="none",e.custom_address&&(_onClick(r=_create("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),function(){n=!0,e.custom_address.getter(function(e){n=!1,e.place="custom",e.formatted_address=formattedAddress(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),addClass(f,"_has_addresses"),f.appendChild(b(e,!0)),C([]),o.value=address2Search(e),g(),v()},function(){n=!1,o.focus()})}),p.appendChild(r)),l.license_img&&p.appendChild(_create(".-license",[_create("img",{src:l.license_img})])),d.appendChild(m),(e.custom_address||l.license_img)&&m.appendChild(p),_onInput(o,debounce(L,e.debounce_duration)),_onFocus(o,function(){var e;m.style.display="",i.address&&!i.address.street_number&&(e=i.address,setTimeout(function(){o.setSelectionRange(e.street.length+2,e.street.length+2)},10),setTimeout(function(){o.setSelectionRange(e.street.length+2,e.street.length+2)},100))}),_onClick(o,function(){m.style.display=""}),_onClick(document,y,!0),o.addEventListener("keydown",function(e){switch(e.keyCode){case 13:if("none"===m.style.display)return;!i.address||!i.address.street_number||_()&&Number(_())!==Number(i.address.street_number)?h():(e.preventDefault(),v());break;case 38:e.preventDefault(),i.prediction&&a&&E(a[a.indexOf(i.prediction)-1]);break;case 40:e.preventDefault(),i.prediction&&a&&E(a[a.indexOf(i.prediction)+1])}}),m.addEventListener("mousedown",function(e){s=!1}),_onBlur(o,function(){setTimeout(function(){c.activeElement!==o&&(s?s=!1:v())},100)}),t.input=o,t.focus=function(){return o.focus(),t},Object.defineProperty(t,"value",{get:function(){return o.value},set:function(e){o.value=e,L()}}),Object.defineProperty(t,"address",{get:function(){return i.address},set:function(e){e&&e.place&&("custom"===e.place?(addClass(f,"_has_addresses"),f.appendChild(b(e,!0)),C([]),o.value=address2Search(e)):(o.value=address2Search(e,!0),C([e.place]),E(e.place,!1)),i.address=e,g(),c.activeElement!==o&&v())}}),o.value&&L();var S=e.try_searches||[];return function t(){var n=S.shift();n?l.getPredictions(n,function(e){e&&e[0]?(C(e),E(e[0]),o.value=n):t()}):a=[]}(),t},module.exports=AddressTypeahead;