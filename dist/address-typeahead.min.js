"use strict";var _now=Date.now||function(){return(new Date).getTime()};function debounce(n,o){var i=null,s=_now();function r(e,t){n.apply(e,t),s=_now(),i=setTimeout(function(){i=null},o)}return o=o||400,function(){var e=this,t=arguments;!i||_now()-s>o?r(e,t):(clearTimeout(i),i=setTimeout(function(){r(e,t)},o))}}var arrayShift=[].shift;function isArray(e){return e instanceof Array}function isObject(e){return"object"==typeof e&&null!==e}function _runListeners(t,n){return function(e){e.apply(n,t)}}function _runDelayed(e,t){return function(){setTimeout(t,e)}}function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _removeItem(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}function eventMethods(i){var s={},r={};return(i=i||{}).on=function(e,t){return s[e]=s[e]||[],s[e].push(t),i},i.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),i},i.off=function(e,t){return s[e]&&_removeItem(s[e],t),i},i.emit=function(e,t,n){var o=_runListeners(t,n);return s[e]&&s[e].forEach(o),r[e]&&r[e].splice(0).forEach(o),i},i}var arrayShift$1=Array.prototype.shift;function __extractProps(e,n){return(e||"").replace(/#([^\s.]+)/,function(e,t){return n.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return n.className=n.className?n.className+" "+t:t,""})}function __create(e,t,n,o){var i,s=document.createElement(e||"div");if(t)for(i in t)s.setAttribute(i,t[i]);for(i in n)s[i]=n[i];return o&&o.forEach(function(e){s.appendChild(e)}),s}function _create(){var e,t,n,o=arrayShift$1.call(arguments);return"string"!=typeof o?(e=o,o=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},__create(o=__extractProps(o,t),e,t,n)}var classListEnabled="classList"in document.documentElement,_toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function _on(e,t,n,o){return e.addEventListener(t,n,o)}function _off(e,t,n,o){return e.removeEventListener(t,n,o)}function GooglePlaceTypeahead(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var callback_num=0;function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},GooglePlaceTypeahead.prototype.getPredictions=function(n,o,i){if("string"==typeof n&&(n=n.trim()),n){var s=this,r=s.predictions_cache;return r[n]?o(r[n]):s.load(function(){s.service.autocomplete.getPlacePredictions(_merge({},s.options,{input:n,sessionToken:s.options.session_token||s.session_token}),function(e,t){t==s.predictions_OK?(r[n]=e,o instanceof Function&&o(e)):i instanceof Function&&i(t)})}),s}o instanceof Function&&o([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,o=0,i=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,c=e.matched_substrings.length;r<c;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,s+=i.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+i.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return s+=i.substr(o)};var _place_fields="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function _commaIf(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function _address2Search(e,t,n){if(!e)return"";var o=e.sublocality||e.locality||e.city;return e.street+(_commaIf(e.street_number)||(t?", ":""))+_commaIf(!1!==n&&o!==e.street&&o)}function _formattedAddress(e,t,n,o){return e?e.street+_commaIf(e.street_number||(t?" ":""))+_commaIf(e.postcode+" "+e.locality)+_commaIf(e.province!==e.locality&&e.province)+_commaIf(n&&e.region)+_commaIf(o&&e.country):""}function _numberTyped(e){var t=e&&e.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return t?t[1]:null}function _cursorToNumberPosition(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}GooglePlaceTypeahead.prototype.getAddress=function(n,o,i){var s=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(s[n.place_id])return o(s[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||_place_fields},function(e,t){"OK"===t?(s[n.place_id]=_parsePlace(e,n),o instanceof Function&&o(s[n.place_id])):i instanceof Function&&i(t)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var _push=Array.prototype.push;function TypeaheadPredictions(n,e){var t,o=this,i=_create(".-predictions-list"),s=_create(".-predictions-footer"),r=_create(e.wrapper_selector||".apz-typeahead_predictions",[i]);eventMethods(o),o.TA=n,o.options=e,o.wrapper_el=r,o.list_el=i,o.custom_predictions=[],o._onDocumentClick=function(e){var t=e.target;if(!o.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===r||t===n.input_el)return;t=t.parentElement}o.hide()}},o.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(r),e.license_img&&s.appendChild(_create(".-license",[_create("img",{src:e.license_img})])),e.custom_address&&(_on(t=_create("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){o.showing_custom=!0,e.custom_address.getter(function(e){o.showing_custom=!1,e.place="custom",e.formatted_address=_formattedAddress(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),o.setPredictions([],e),o.render(),o.select(e),o.emit("custom_address",[e])},function(){o.showing_custom=!1,o.emit("cancel-custom_address")})}),s.appendChild(t)),(e.custom_address||e.license_img)&&r.appendChild(s)}function _selectDelta(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}TypeaheadPredictions.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),_on(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hide=function(){this.wrapper_el.style.display="none",this.is_hidden=!0,_off(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},TypeaheadPredictions.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,o=t.length;n<o;n++)_toggleClass(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},TypeaheadPredictions.prototype.selectPrevious=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,-1)},TypeaheadPredictions.prototype.selectNext=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,1)},TypeaheadPredictions.prototype.setPredictions=function(e,t){var n=this;e&&(e=e.slice());var o=(e=e||n.predictions_data||[]).slice();n.options.keep_custom?n.custom_predictions.length&&(t&&n.custom_predictions.push(t),_push.apply(o,n.custom_predictions)):t&&o.push(t),n.predictions_data=e,n.loaded_predictions=o,n.selected&&o.indexOf(n.selected)<0&&n.select(null)},TypeaheadPredictions.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},TypeaheadPredictions.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},TypeaheadPredictions.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,o,i,s=t.loaded_predictions||[],r=this.list_el,c=this.wrapper_el,a=r.children;function l(){t.select(this.prediction)}if(_toggleClass(c,"_has-predictions",t.predictions_data&&t.predictions_data.length),_toggleClass(c,"_has-custom_predictions",t.custom_predictions.length),s.length>a.length)for(n=0,o=s.length-a.length;n<o;n++)i=_create(".-prediction",{tabindex:"0"}),r.appendChild(i),_on(i,"click",l);for(n=0,o=s.length;n<o;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(s[n])||_address2Search(s[n]),a[n].prediction=s[n],_toggleClass(a[n],"_is-custom","custom"===s[n].place),_toggleClass(a[n],"_is-selected",s[n]===t.selected);if(s.length<a.length)for(;a[s.length];)r.removeChild(a[s.length])};var KEY_ENTER=13,KEY_UP=38,KEY_DOWN=40;function __trySearches(t,n,o){var i=t.shift();i&&n(i,function(e){e&&e[0]?o(e,i):__trySearches(t,n,o)})}function AddressTypeahead(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new GooglePlaceTypeahead(e.google).load())}AddressTypeahead.prototype.bind=function(o,e){var t=null,n=!1,i=null,s=null,r=eventMethods({get value(){return o.value},set value(e){o.value=e,_()},get address(){return t},set address(e){e&&e.place&&("custom"===(t=e).place?(l.addCustomPrediction(e),o.value=_address2Search(e)):(l.setPredictions([e.place]),o.value=_address2Search(e,!0)),l.select(e),d("change"))}});e=e||{};var c=this.focus_root,a=this.provider;"string"==typeof o&&(o=c.querySelector(o)),this.input_el=o;var l=new TypeaheadPredictions(this,e);function d(e){r.emit(e,[o.value,t,n])}function u(e){t=e,d("change")}var p=null;function _(){if(o.value!==p){if(p=o.value,n=_numberTyped(o.value),!o.value)return i="",l.clear(),u(null);var t=o.value;a.getPredictions(o.value,function(e){l.render(e),e.length&&o.value===t&&e[0]&&e.indexOf(l.selected)<0&&l.select(e[0])})}else c.activeElement===o&&l.show()}l.on("selected",function(e){if(!e)return u(null);var t,n;i=o.value,"custom"===e.place?u(e):(t=e,s=[],a.getAddress(t,function(e){o.value===i&&l.selected===t&&(u(e),n instanceof Function&&n(e),s.forEach(_runListeners([e])),s=null)}))});var f=debounce(_,e.debounce_duration);function h(){l.show(),t&&!t.street_number?(o.value=_formattedAddress(t,!0),_cursorToNumberPosition(o,t)):t&&(o.value=_address2Search(t,!0,!1)),_()}function m(e){o.value=_formattedAddress(e,!0)}return _on(o,"input",f),_on(o,"change",f),_on(o,"focus",h),_on(o,"click",h),l.on("cancel-custom_address",function(){o.focus()}),_on(o,"click",function(){l.show()}),o.addEventListener("keydown",function(e){switch(e.keyCode!==KEY_ENTER&&l.show(),e.keyCode){case KEY_ENTER:if(l.is_hidden)return;e.preventDefault(),t&&!t.street_number?(o.value=_address2Search(t,!0,!0),_cursorToNumberPosition(o,t),_()):(s?s.push(m):m(t),l.hide());break;case KEY_UP:e.preventDefault(),l.selectPrevious();break;case KEY_DOWN:e.preventDefault(),l.selectNext()}}),_on(o,"blur",_runDelayed(100,function(){s?s.push(m):m(t),l.showing_custom||c.activeElement===o||l.hide()})),r.input=o,r.focus=function(){return o.focus(),r},o.value?_():e.try_searches&&__trySearches(e.try_searches,a.getPredictions.bind(a),function(e,t){l.setPredictions(e),l.select(e[0]),o.value=t}),r},module.exports=AddressTypeahead;