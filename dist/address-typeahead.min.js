"use strict";var arrayShift=[].shift;function isArray(e){return e instanceof Array}function isObject(e){return"object"==typeof e&&null!==e}function _runListeners(t,n){return function(e){e.apply(n,t)}}function _runDelayed(e,t){return function(){setTimeout(t,e)}}function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _removeItem(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}function eventMethods(i){var s={},r={};return(i=i||{}).on=function(e,t){return s[e]=s[e]||[],s[e].push(t),i},i.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),i},i.off=function(e,t){return s[e]&&_removeItem(s[e],t),i},i.emit=function(e,t,n){var o=_runListeners(t,n);return s[e]&&s[e].forEach(o),r[e]&&r[e].splice(0).forEach(o),i},i}var arrayShift$1=Array.prototype.shift;function __extractProps(e,n){return(e||"").replace(/#([^\s.]+)/,function(e,t){return n.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return n.className=n.className?n.className+" "+t:t,""})}function __create(e,t,n,o){var i,s=document.createElement(e||"div");if(t)for(i in t)s.setAttribute(i,t[i]);for(i in n)s[i]=n[i];return o&&o.forEach(function(e){s.appendChild(e)}),s}function _create(){var e,t,n,o=arrayShift$1.call(arguments);return"string"!=typeof o?(e=o,o=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},__create(o=__extractProps(o,t),e,t,n)}var classListEnabled="classList"in document.documentElement,_toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function _on(e,t,n,o){return e.addEventListener(t,n,o)}function _off(e,t,n,o){return e.removeEventListener(t,n,o)}function GooglePlaceTypeahead(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var callback_num=0;function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},GooglePlaceTypeahead.prototype.getPredictions=function(n,o,i){if("string"==typeof n&&(n=n.trim()),n){var s=this,r=s.predictions_cache;return r[n]?o(r[n]):s.load(function(){s.service.autocomplete.getPlacePredictions(_merge({},s.options,{input:n,sessionToken:s.options.session_token||s.session_token}),function(e,t){t==s.predictions_OK?(r[n]=e,o instanceof Function&&o(e)):i instanceof Function&&i(t)})}),s}o instanceof Function&&o([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,o=0,i=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,c=e.matched_substrings.length;r<c;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,s+=i.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+i.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return s+=i.substr(o)};var _place_fields="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function _commaIf(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function _address2Search(e,t,n){if(!e)return"";var o=e.sublocality||e.locality||e.city;return e.street+(_commaIf(e.street_number)||(t?", ":""))+_commaIf(!1!==n&&o!==e.street&&o)}function _formattedAddress(e,t,n,o){return e?e.street+_commaIf(e.street_number||(t?" ":""))+_commaIf(e.postcode+" "+e.locality)+_commaIf(e.province!==e.locality&&e.province)+_commaIf(n&&e.region)+_commaIf(o&&e.country):""}function _numberTyped(e){var t=e&&e.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return t?t[1]:null}function _cursorToNumberPosition(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}GooglePlaceTypeahead.prototype.getAddress=function(n,o,i){var s=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(s[n.place_id])return o(s[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||_place_fields},function(e,t){"OK"===t?(s[n.place_id]=_parsePlace(e,n),o instanceof Function&&o(s[n.place_id])):i instanceof Function&&i(t)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var _push=Array.prototype.push;function TypeaheadPredictions(n,e){var t,o=this,i=_create(".-predictions-list"),s=_create(".-predictions-footer"),r=_create(e.wrapper_selector||".apz-typeahead_predictions",[i]);eventMethods(o),o.TA=n,o.options=e,o.wrapper_el=r,o.list_el=i,o.custom_predictions=[],o._onDocumentClick=function(e){var t=e.target;if(!o.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===r||t===n.input_el)return;t=t.parentElement}o.hide()}},o.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(r),e.custom_address&&(_on(t=_create("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){o.showing_custom=!0,e.custom_address.getter(function(e){o.showing_custom=!1,e.place="custom",e.formatted_address=_formattedAddress(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),o.setPredictions([],e),o.render(),o.select(e),o.emit("custom_address",[e]),o.hide()},function(){o.showing_custom=!1,o.emit("cancel-custom_address")})}),s.appendChild(t));var c=e.custom_provider_image||n.provider.license_img;c&&s.appendChild(_create(".-license",[_create("img",{src:c})])),(e.custom_address||c)&&r.appendChild(s)}function _selectDelta(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}TypeaheadPredictions.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),_on(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hide=function(){this.wrapper_el.style.display="none",this.is_hidden=!0,_off(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},TypeaheadPredictions.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,o=t.length;n<o;n++)_toggleClass(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},TypeaheadPredictions.prototype.selectPrevious=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,-1)},TypeaheadPredictions.prototype.selectNext=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,1)},TypeaheadPredictions.prototype.setPredictions=function(e,t){var n=this;e&&(e=e.slice());var o=(e=e||n.predictions_data||[]).slice();n.options.keep_custom?n.custom_predictions.length&&(t&&n.custom_predictions.push(t),_push.apply(o,n.custom_predictions)):t&&o.push(t),n.predictions_data=e,n.loaded_predictions=o,n.select(n.selected&&0<=o.indexOf(n.selected)?n.selected:o[0]||null)},TypeaheadPredictions.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},TypeaheadPredictions.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},TypeaheadPredictions.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,o,i,s=t.loaded_predictions||[],r=this.list_el,c=this.wrapper_el,a=r.children;function l(){t.select(this.prediction)}if(_toggleClass(c,"_has-predictions",t.predictions_data&&t.predictions_data.length),_toggleClass(c,"_has-custom_predictions",t.custom_predictions.length),s.length>a.length)for(n=0,o=s.length-a.length;n<o;n++)i=_create(".-prediction",{tabindex:"0"}),r.appendChild(i),_on(i,"click",l);for(n=0,o=s.length;n<o;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(s[n])||_address2Search(s[n]),a[n].prediction=s[n],_toggleClass(a[n],"_is-custom","custom"===s[n].place),_toggleClass(a[n],"_is-selected",s[n]===t.selected);if(s.length<a.length)for(;a[s.length];)r.removeChild(a[s.length])};var KEY_ENTER=13,KEY_UP=38,KEY_DOWN=40,KEY_ESC=27;function __trySearches(t,n,o){var i=t.shift();i&&n(i,function(e){e&&e[0]?o(e,i):__trySearches(t,n,o)})}function AddressTypeahead(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new GooglePlaceTypeahead(e.google).load())}AddressTypeahead.prototype.bind=function(i,t){var n=null,o=!1,s=null,r=null,c=null,a=eventMethods({get value(){return i.value},set value(e){i.value=e,g()},get address(){return n},set address(e){e&&e.place&&("custom"===(n=e).place?(u.addCustomPrediction(e),i.value=_address2Search(e),u.select(e)):(u.setPredictions([e.place]),i.value=_address2Search(e,!0),u.select(e.place)),_("change"))}});t=t||{};var l=this.focus_root,d=this.provider;"string"==typeof i&&(i=l.querySelector(i)),this.input_el=i;var u=new TypeaheadPredictions(this,t);function p(e){i.value=e}function _(e){a.emit(e,[i.value,n,o])}function f(e){c=null,n=e,_("change")}var h=null;function m(){r&&(r.timeout&&clearTimeout(r.timeout),r=null)}function g(){if(i.value!==h){var e=r;if(m(),h=i.value,o=_numberTyped(i.value),!i.value)return s="",u.clear(),void f(null);var n=i.value;r={listeners:[],input_value:i.value,timeout:setTimeout(function(){d.getPredictions(i.value,function(e){if(u.render(e),e.length&&i.value===n&&r){var t=r.listeners;m(),t.forEach(_runListeners(e))}},function(){i.value===n&&m()})},e?t.debounce_duration||400:0)}}else l.activeElement===i&&u.show()}function e(){u.show(),n&&!n.street_number?(p(_formattedAddress(n,!0)),_cursorToNumberPosition(i,n)):n&&p(_address2Search(n,!0,!1))}function y(){r?r.listeners.push(y):c?c.push(y):(n&&!n.street_number?(p(_address2Search(n,!0,!0)),_cursorToNumberPosition(i,n),g()):(v(n),u.hide()),t.onEnter instanceof Function&&t.onEnter(n))}function v(e){p(_formattedAddress(e,!0))}return u.on("selected",function(e){if(!e)return f(null);var n,o;s=i.value,"custom"===e.place?f(e):(n=e,c=[],d.getAddress(n,function(e){if(i.value===s&&u.selected===n){var t=c;f(e),o instanceof Function&&o(e),t&&t.forEach(_runListeners([e]))}}))}),_on(i,"input",g),_on(i,"change",g),_on(i,"focus",e),_on(i,"click",e),u.on("cancel-custom_address",function(){i.focus()}),_on(i,"click",function(){u.show()}),i.addEventListener("keydown",function(e){switch(e.keyCode!==KEY_ENTER&&u.show(),e.keyCode){case KEY_ESC:p(""),g();break;case KEY_ENTER:if(u.is_hidden)return;e.preventDefault(),y();break;case KEY_UP:e.preventDefault(),u.selectPrevious();break;case KEY_DOWN:e.preventDefault(),u.selectNext()}}),_on(i,"blur",_runDelayed(100,function(){c?c.push(v):v(n),u.showing_custom||l.activeElement===i||u.hide()})),a.input=i,a.focus=function(){return i.focus(),a},i.value?g():t.try_searches&&__trySearches(t.try_searches,d.getPredictions.bind(d),function(e,t){u.setPredictions(e),u.select(e[0]),p(t)}),a},module.exports=AddressTypeahead;