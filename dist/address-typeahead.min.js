"use strict";var arrayShift=[].shift;function isArray(e){return e instanceof Array}function isObject(e){return"object"==typeof e&&null!==e}function _runListeners(t,n){return function(e){e.apply(n,t)}}function _runDelayed(e,t){return function(){setTimeout(t,e)}}function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _removeItem(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}function eventMethods(s){var i={},r={};return(s=s||{}).on=function(e,t){return i[e]=i[e]||[],i[e].push(t),s},s.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),s},s.off=function(e,t){return i[e]&&_removeItem(i[e],t),s},s.emit=function(e,t,n){var o=_runListeners(t,n);return i[e]&&i[e].forEach(o),r[e]&&r[e].splice(0).forEach(o),s},s}var arrayShift$1=Array.prototype.shift;function __extractProps(e,n){return(e||"").replace(/#([^\s.]+)/,function(e,t){return n.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return n.className=n.className?n.className+" "+t:t,""})}function __create(e,t,n,o){var s,i=document.createElement(e||"div");if(t)for(s in t)i.setAttribute(s,t[s]);for(s in n)i[s]=n[s];return o&&o.forEach(function(e){i.appendChild(e)}),i}function _create(){var e,t,n,o=arrayShift$1.call(arguments);return"string"!=typeof o?(e=o,o=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},__create(o=__extractProps(o,t),e,t,n)}var classListEnabled="classList"in document.documentElement,_toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function _on(e,t,n,o){return e.addEventListener(t,n,o)}function _off(e,t,n,o){return e.removeEventListener(t,n,o)}function GooglePlaceTypeahead(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var callback_num=0;function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},GooglePlaceTypeahead.prototype.getPredictions=function(n,o,s){if("string"==typeof n&&(n=n.trim()),n){var i=this,r=i.predictions_cache;return r[n]?o(r[n]):i.load(function(){i.service.autocomplete.getPlacePredictions(_merge({},i.options,{input:n,sessionToken:i.options.session_token||i.session_token}),function(e,t){t==i.predictions_OK?(r[n]=e,o instanceof Function&&o(e)):s instanceof Function&&s(t)})}),i}o instanceof Function&&o([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,o=0,s=e.description,i="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,c=e.matched_substrings.length;r<c;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,i+=s.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),i+="<strong>"+s.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return i+=s.substr(o)};var _place_fields="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function _commaIf(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function _address2Search(e,t,n){if(!e)return"";var o=e.sublocality||e.locality||e.city;return e.street+(_commaIf(e.street_number)||(t?", ":""))+_commaIf(!1!==n&&o!==e.street&&o)}function _formattedAddress(e,t,n,o){return e?e.street+_commaIf(e.street_number||(t?" ":""))+_commaIf(e.postcode+" "+e.locality)+_commaIf(e.province!==e.locality&&e.province)+_commaIf(n&&e.region)+_commaIf(o&&e.country):""}function _numberTyped(e){var t=e&&e.match(/.+?\w+[ ,]+(\d+)/);return t?t[1]:null}function _cursorToNumberPosition(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}GooglePlaceTypeahead.prototype.getAddress=function(n,o,s){var i=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(i[n.place_id])return o(i[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||_place_fields},function(e,t){"OK"===t?(i[n.place_id]=_parsePlace(e,n),o instanceof Function&&o(i[n.place_id])):s instanceof Function&&s(t)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var _push=Array.prototype.push;function TypeaheadPredictions(n,e){var t,o=this,s=_create(".-predictions-list"),i=_create(".-predictions-footer"),r=_create(e.wrapper_selector||".apz-typeahead_predictions",[s]);eventMethods(o),o.TA=n,o.options=e,o.wrapper_el=r,o.list_el=s,o.custom_predictions=[],o._onDocumentClick=function(e){var t=e.target;if(!o.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===r||t===n.input_el)return;t=t.parentElement}o.hide()}},o.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(r),e.custom_address&&(_on(t=_create("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){o.showing_custom=!0,e.custom_address.getter(function(e){o.showing_custom=!1,e.place="custom",e.formatted_address=_formattedAddress(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),o.setPredictions([],e),o.render(),o.select(e),o.emit("custom_address",[e]),o.hide()},function(){o.showing_custom=!1,o.emit("cancel-custom_address")})}),i.appendChild(t));var c=e.custom_provider_image||n.provider.license_img;c&&i.appendChild(_create(".-license",[_create("img",{src:c})])),(e.custom_address||c)&&r.appendChild(i)}function _selectDelta(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}TypeaheadPredictions.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),_on(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hide=function(){this.wrapper_el.style.display="none",this.is_hidden=!0,_off(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},TypeaheadPredictions.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,o=t.length;n<o;n++)_toggleClass(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},TypeaheadPredictions.prototype.selectPrevious=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,-1)},TypeaheadPredictions.prototype.selectNext=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,1)},TypeaheadPredictions.prototype.setPredictions=function(e,t){var n=this;e&&(e=e.slice());var o=(e=e||n.predictions_data||[]).slice();n.options.keep_custom?n.custom_predictions.length&&(t&&n.custom_predictions.push(t),_push.apply(o,n.custom_predictions)):t&&o.push(t),n.predictions_data=e,n.loaded_predictions=o,n.select(n.selected&&0<=o.indexOf(n.selected)?n.selected:o[0]||null)},TypeaheadPredictions.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},TypeaheadPredictions.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},TypeaheadPredictions.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,o,s,i=t.loaded_predictions||[],r=this.list_el,c=this.wrapper_el,a=r.children;function l(){t.select(this.prediction)}if(_toggleClass(c,"_has-predictions",t.predictions_data&&t.predictions_data.length),_toggleClass(c,"_has-custom_predictions",t.custom_predictions.length),i.length>a.length)for(n=0,o=i.length-a.length;n<o;n++)s=_create(".-prediction",{tabindex:"0"}),r.appendChild(s),_on(s,"click",l);for(n=0,o=i.length;n<o;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(i[n])||_address2Search(i[n]),a[n].prediction=i[n],_toggleClass(a[n],"_is-custom","custom"===i[n].place),_toggleClass(a[n],"_is-selected",i[n]===t.selected);if(i.length<a.length)for(;a[i.length];)r.removeChild(a[i.length])};var KEY_ENTER=13,KEY_UP=38,KEY_DOWN=40,KEY_ESC=27;function __trySearches(t,n,o){var s=t.shift();s&&n(s,function(e){e&&e[0]?o(e,s):__trySearches(t,n,o)})}function AddressTypeahead(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new GooglePlaceTypeahead(e.google).load())}AddressTypeahead.prototype.bind=function(s,t){var n=null,o=!1,i=null,r=null,c=null,a=null,l=eventMethods({get value(){return s.value},set value(e){s.value=e,y()},get address(){return n},set address(e){e&&e.place&&("custom"===(n=e).place?(p.addCustomPrediction(e),s.value=_address2Search(e),p.select(e)):(p.setPredictions([e.place]),s.value=_address2Search(e,!0),p.select(e.place)),f("change"))}});t=t||{};var d=this.focus_root,u=this.provider;"string"==typeof s&&(s=d.querySelector(s)),this.input_el=s;var p=new TypeaheadPredictions(this,t);function _(e){s.value=e}function f(e){l.emit(e,[s.value,n,o])}function h(e){if(c=null,n=e,a){if(!e||!e.street_number)return n=null,void p.clear();_(_address2Search(n,!0,!1)),a=null}f("change")}var m=null;function g(){r&&(r.timeout&&clearTimeout(r.timeout),r=null)}function y(){if(s.value!==m){var e=r;if(g(),m=s.value,o=_numberTyped(s.value),!s.value)return i="",p.clear(),void h(null);var n=s.value;r={listeners:[],input_value:s.value,timeout:setTimeout(function(){u.getPredictions(s.value,function(e){if(p.render(e),e.length&&s.value===n&&r){var t=r.listeners;g(),t.forEach(_runListeners(e))}},function(){s.value===n&&g()})},e?t.debounce_duration||400:0)}}else d.activeElement===s&&p.show()}function e(){p.show(),n&&!n.street_number?(_(_formattedAddress(n,!0)),_cursorToNumberPosition(s,n)):n&&_(_address2Search(n,!0,!1))}function v(){r?r.listeners.push(v):c?c.push(v):(n&&!n.street_number?(_(_address2Search(n,!0,!0)),_cursorToNumberPosition(s,n),y()):(b(),p.hide()),t.onEnter instanceof Function&&t.onEnter(n))}function b(){r?r.listeners.push(b):c?c.push(b):(_(_formattedAddress(n,!0)),o=!1,f("change"))}return p.on("selected",function(e){if(!e)return h(null);var n,o;i=s.value,"custom"===e.place?h(e):(n=e,c=[],u.getAddress(n,function(e){if(s.value===i&&p.selected===n){var t=c;h(e),o instanceof Function&&o(e),t&&t.forEach(_runListeners([e]))}}))}),_on(s,"input",y),_on(s,"change",y),_on(s,"focus",e),_on(s,"click",e),p.on("cancel-custom_address",function(){s.focus()}),_on(s,"click",function(){p.show()}),s.addEventListener("keydown",function(e){switch(e.keyCode!==KEY_ENTER&&p.show(),e.keyCode){case KEY_ESC:_(""),y();break;case KEY_ENTER:if(p.is_hidden)return;e.preventDefault(),v();break;case KEY_UP:e.preventDefault(),p.selectPrevious();break;case KEY_DOWN:e.preventDefault(),p.selectNext()}}),_on(s,"blur",_runDelayed(100,function(){b(),p.showing_custom||d.activeElement===s||p.hide()})),l.input=s,l.focus=function(){return s.focus(),l},s.value?y():t.try_searches&&__trySearches(t.try_searches,u.getPredictions.bind(u),function(e,t){p.setPredictions(e),p.select(e[0]),a=t}),l},module.exports=AddressTypeahead;