"use strict";function debounce(e,t){var n=null,r=_now(),s=function(s,o){e.apply(s,o),r=_now(),n=setTimeout(function(){n=null},t)};return t=t||400,function(){var e=this,o=arguments;!n||_now()-r>t?s(e,o):(clearTimeout(n),n=setTimeout(function(){s(e,o)},t))}}function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _find(e,t,n){for(var r=0,s=e.length;r<s;r++)if(t.call(n,e[r],r))return e[r]}function _removeItem(e,t){for(var n=e.length-1;n>=0;n--)e[n]===t&&e.splice(n,1)}function eventMethods(e){var t={},n={};return e=e||{},e.on=function(n,r){return t[n]=t[n]||[],t[n].push(r),e},e.once=function(t,r){return n[t]=n[t]||[],n[t].push(r),e},e.off=function(n,r){return t[n]&&_removeItem(t[n],r),e},e.emit=function(r,s,o){return t[r]&&t[r].forEach(function(e){e.apply(o,s)}),n[r]&&n[r].splice(0).forEach(function(e){e.apply(o,s)}),e},e}function GooglePlaceTypeahead(e){this.options=e,this.loading_listeners=[]}function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var r={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(r.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),r}function __extractProps(e,t){return(e||"").replace(/#([^\s.]+)/,function(e,n){return t.id=n,""}).replace(/\.([^\s.]+)/g,function(e,n){return t.className=t.className?t.className+" "+n:n,""})}function __create(e,t,n,r){var s,o=document.createElement(e||"div");if(t)for(s in t)o.setAttribute(s,t[s]);for(s in n)o[s]=n[s];return r&&r.forEach(function(e){o.appendChild(e)}),o}function _create(){var e,t,n,r=arrayShift$1.call(arguments);return"string"!=typeof r?(e=r,r=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},r=__extractProps(r,t),__create(r,e,t,n)}function _onClick(e,t,n){return e.addEventListener("click",t,n)}function _offClick(e,t,n){return e.removeEventListener("click",t,n)}function _onInput(e,t,n){return e.addEventListener("input",t,n)}function _onFocus(e,t,n){return e.addEventListener("focus",t,n)}function _onBlur(e,t,n){return e.addEventListener("blur",t,n)}function commaIf(e){return e?", "+e:""}function address2Search(e,t){if(!e)return"";var n=e.sublocality||e.locality||e.city;return e.street+(commaIf(e.street_number)||(t?", ":""))+commaIf(n!==e.street&&n)}function formattedAddress(e){return e?e.street+commaIf(e.street_number)+commaIf(e.postcode+" "+e.locality)+commaIf(e.province)+commaIf(e.region)+commaIf(e.country):""}function AddressTypeahead(e){this.options=e||{},this.options.google&&(this.provider=new GooglePlaceTypeahead(this.options.google).load())}var _now=Date.now||function(){return(new Date).getTime()},arrayShift=[].shift,isArray=function(e){return e instanceof Array},isObject=function(e){return"object"==typeof e&&null!==e},callback_num=0;GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);{if(!t.loading){var n=window.document.createElement("script"),r="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[r]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+r,window.document.head.appendChild(n),this}t.loading_listeners.push(e)}},GooglePlaceTypeahead.prototype.getPredictions=function(e,t,n){if(e)return this.load(function(r){r.service.autocomplete.getPlacePredictions(_merge({},r.options,{input:e}),function(e,s){s==r.predictions_OK?t instanceof Function&&t(e):n instanceof Function&&n(s)})});t instanceof Function&&t([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,r=0,s=e.description,o="";if(!e.matched_substrings)return e.formatted_address;for(var a=0,i=e.matched_substrings.length;a<i;a++)t=e.matched_substrings[a].offset,n=e.matched_substrings[a].length,o+=s.substr(r,t-r).replace(/^ | $/g,"&nbsp;"),o+="<strong>"+s.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",r=t+n;return o+=s.substr(r)},GooglePlaceTypeahead.prototype.getAddress=function(e,t,n){this.service.place.getDetails(e,function(e,r){"OK"===r?t instanceof Function&&t(_parsePlace(e)):n instanceof Function&&n(r)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var arrayShift$1=Array.prototype.shift,classListEnabled="classList"in document.documentElement,hasClass=classListEnabled?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},addClass=classListEnabled?function(e,t){e.classList.add(t)}:function(e,t){hasClass(e,t)||(e.className+=" "+t)},removeClass=classListEnabled?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};AddressTypeahead.prototype.bind=function(e,t){function n(){var t=e.value&&e.value.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return t?t[1]:null}function r(){p.emit("change",[e.value,g.address,n()])}function s(){p.emit("blur",[e.value,g.address,n()])}function o(){v||(!g.address||g.address.street_number||n()||(c([]),e.value=address2Search(g.address,!0)),w.style.display="none",s(),_offClick(document,a,!0))}function a(t){var n=t.target;if(document.activeElement!==e){for(;n&&n!==document.body;){if(n===w||n===e)return;n=n.parentElement}o(),y=!1}}function i(t,n){var r=_create(".-prediction._custom"),s=function(){d(),c([]),addClass(r,"_selected"),g.address=t,e.value=address2Search(t),o()};return r.innerHTML=address2Search(t),_onClick(r,s),n&&s(),r}function c(t){var s,a,i=b.children;if(t&&(m=t),toggleClass(w,"_has_predictions",m.length),m.length>i.length)for(s=0,a=m.length-i.length;s<a;s++)b.appendChild(function(){var t=_create(".-prediction");return _onClick(t,function(){l(this.getAttribute("data-predition"),function(){var t=n();return g.address&&g.address.street_number?t&&Number(t)!==Number(g.address.street_number)?(document.activeElement!==e&&e.focus(),void r()):void o():(document.activeElement!==e&&e.focus(),void r())})}),t}());for(s=0,a=m.length;s<a;s++)i[s].innerHTML=h.getPredictionHTML(m[s])||address2Search(m[s]),i[s].setAttribute("data-predition",m[s].id),toggleClass(i[s],"_custom","custom"===m[s].place);if(m.length<i.length)for(;i[m.length];)b.removeChild(i[m.length])}function l(t,s){"string"==typeof t&&(t=_find(m,function(e){return e.id===t})),t&&(d(),_find(b.children,function(e){if(e.getAttribute("data-predition")===t.id)return addClass(e,"_selected"),!0}),g.prediction=t,!1!==s?h.getAddress(t,function(o){t===g.prediction&&(g.address=o,document.activeElement===e||!g.address||g.address.street_number||n()||(e.value=address2Search(o,!0)),s instanceof Function&&s(),r())}):r())}function d(){var e,t,n=b.children;for(e=0,t=n.length;e<t;e++)removeClass(n[e],"_selected");for(e=0,t=(n=C.children).length;e<t;e++)removeClass(n[e],"_selected");delete g.prediction}function u(){if(g.address&&g.address.custom&&d(),delete g.address,!e.value)return c([]),d(),void r();h.getPredictions(e.value,function(e){c(e),m[0]&&l(m[0])})}function f(){var t=L.shift();t?h.getPredictions(t,function(n){n&&n[0]?(c(n),l(n[0]),e.value=t):f()}):m=[]}var p=eventMethods({}),m=[],g={};t=t||{},"string"==typeof e&&(e=document.querySelector(e));var _=t.predictions_parent?"string"==typeof t.predictions_parent?document.querySelector(t.predictions_parent):t.predictions_parent:e.parentElement,h=this.provider,v=!1,y=!1,b=_create(".-predictions-list"),C=_create(".-predictions-list._custom-list"),E=_create(".-predictions-footer"),w=_create(".apz-address-typeahead-predictions",[b,C]);w.style.display="none",t.custom_address&&function(){var n=_create("button.-custom-address",{type:"button"},{textContent:t.custom_address.label});_onClick(n,function(){v=!0,t.custom_address.getter(function(t){v=!1,t.place="custom",t.formatted_address=formattedAddress(t),t.url="https://maps.google.com/?q="+encodeURIComponent(t.formatted_address),addClass(C,"_has_addresses"),C.appendChild(i(t,!0)),c([]),e.value=address2Search(t),r(),o()},function(){v=!1,e.focus()})}),E.appendChild(n)}(),h.license_img&&E.appendChild(_create(".-license",[_create("img",{src:h.license_img})])),_.appendChild(w),(t.custom_address||h.license_img)&&w.appendChild(E),_onInput(e,debounce(u)),_onFocus(e,function(){w.style.display="",g.address&&!g.address.street_number&&function(t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}(g.address)}),_onClick(e,function(){w.style.display=""}),_onClick(document,a,!0),e.addEventListener("keydown",function(e){switch(e.keyCode){case 13:!g.address||!g.address.street_number||n()&&Number(n())!==Number(g.address.street_number)?s():(e.preventDefault(),o());break;case 38:e.preventDefault(),g.prediction&&m&&l(m[m.indexOf(g.prediction)-1]);break;case 40:e.preventDefault(),g.prediction&&m&&l(m[m.indexOf(g.prediction)+1])}}),w.addEventListener("mousedown",function(e){y=!1}),_onBlur(e,function(){setTimeout(function(){document.activeElement!==e&&(y?y=!1:o())},100)}),p.input=e,p.focus=function(){return e.focus(),p},Object.defineProperty(p,"value",{get:function(){return e.value},set:function(t){e.value=t,u()}}),Object.defineProperty(p,"address",{get:function(){return g.address},set:function(t){t&&t.place&&("custom"===t.place?(addClass(C,"_has_addresses"),C.appendChild(i(t,!0)),c([]),e.value=address2Search(t)):(e.value=address2Search(t,!0),c([t.place]),l(t.place,!1)),g.address=t,r(),document.activeElement!==e&&o())}}),e.value&&u();var L=t.try_searches||[];return f(),p},module.exports=AddressTypeahead;