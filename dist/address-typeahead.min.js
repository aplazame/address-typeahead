"use strict";var arrayShift=[].shift;function isArray(e){return e instanceof Array}function isObject(e){return"object"==typeof e&&null!==e}function _runListeners(t,n){return function(e){e.apply(n,t)}}function _runDelayed(e,t){return function(){setTimeout(t,e)}}function _merge(){for(var e,t=arrayShift.call(arguments),n=arrayShift.call(arguments);n;){if(typeof t!=typeof n&&(t=isArray(n)?[]:isObject(n)?{}:n),isObject(n))for(e in n)void 0===n[e]?t[e]=void 0:isArray(t[e])?[].push.apply(t[e],n[e]):isObject(t[e])?t[e]=_merge(t[e],n[e]):t[e]=n[e];n=arrayShift.call(arguments)}return t}function _removeItem(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}function eventMethods(o){var i={},r={};return(o=o||{}).on=function(e,t){return i[e]=i[e]||[],i[e].push(t),o},o.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),o},o.off=function(e,t){return i[e]&&_removeItem(i[e],t),o},o.emit=function(e,t,n){var s=_runListeners(t,n);return i[e]&&i[e].forEach(s),r[e]&&r[e].splice(0).forEach(s),o},o}var arrayShift$1=Array.prototype.shift;function __extractProps(e,n){return(e||"").replace(/#([^\s.]+)/,function(e,t){return n.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return n.className=n.className?n.className+" "+t:t,""})}function __create(e,t,n,s){var o,i=document.createElement(e||"div");if(t)for(o in t)i.setAttribute(o,t[o]);for(o in n)i[o]=n[o];return s&&s.forEach(function(e){i.appendChild(e)}),i}function _create(){var e,t,n,s=arrayShift$1.call(arguments);return"string"!=typeof s?(e=s,s=null):e=arrayShift$1.call(arguments),e instanceof Array?(n=e,e=null):t=arrayShift$1.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},__create(s=__extractProps(s,t),e,t,n)}var classListEnabled="classList"in document.documentElement,hasClass=classListEnabled?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},_addClass=classListEnabled?function(e,t){e.classList.add(t)}:function(e,t){hasClass(e,t)||(e.className+=" "+t)},_removeClass=classListEnabled?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},_toggleClass=classListEnabled?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function _on(e,t,n,s){return e.addEventListener(t,n,s)}function _off(e,t,n,s){return e.removeEventListener(t,n,s)}function GooglePlaceTypeahead(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var callback_num=0;function _parsePlace(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var s={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(s.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),s}GooglePlaceTypeahead.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),s="__googleAPICallback__"+ ++callback_num;return t.loading=!0,window[s]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+s,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},GooglePlaceTypeahead.prototype.getPredictions=function(n,s,o){if("string"==typeof n&&(n=n.trim()),n){var i=this,r=i.predictions_cache;return r[n]?s(r[n]):i.load(function(){i.service.autocomplete.getPlacePredictions(_merge({},i.options,{input:n,sessionToken:i.options.session_token||i.session_token}),function(e,t){t==i.predictions_OK?(r[n]=e,s instanceof Function&&s(e)):o instanceof Function&&o(t)})}),i}s instanceof Function&&s([])},GooglePlaceTypeahead.prototype.getPredictionHTML=function(e){var t,n,s=0,o=e.description,i="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,a=e.matched_substrings.length;r<a;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,i+=o.substr(s,t-s).replace(/^ | $/g,"&nbsp;"),i+="<strong>"+o.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",s=t+n;return i+=o.substr(s).replace(/^ | $/g,"&nbsp;")};var _place_fields="address_component, adr_address, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function _commaIf(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function _address2Search(e,t,n){if(!e)return"";var s=e.sublocality||e.locality||e.city;return e.street+(_commaIf(e.street_number)||(t?", ":""))+_commaIf(!1!==n&&s!==e.street&&s)}function _formattedAddress(e,t,n,s){return e?e.street+_commaIf(e.street_number||(t?" ":""))+_commaIf(e.postcode?e.postcode+" ":"")+_commaIf(e.locality)+_commaIf(e.province!==e.locality&&e.province)+_commaIf(n&&e.region)+_commaIf(s&&e.country):""}function _numberTyped(e){var t=e&&e.match(/.+?\w+[ ,]+(\d+)/);return t?t[1]:null}function _cursorToNumberPosition(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}GooglePlaceTypeahead.prototype.getAddress=function(n,s,o){var i=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(i[n.place_id])return s(i[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||_place_fields},function(e,t){"OK"===t?(i[n.place_id]=_parsePlace(e,n),s instanceof Function&&s(i[n.place_id])):o instanceof Function&&o(t)})},GooglePlaceTypeahead.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var _push=Array.prototype.push;function TypeaheadPredictions(n,e){var t,s=this,o=_create(".-predictions-list"),i=_create(".-predictions-footer"),r=_create(e.wrapper_selector||".apz-typeahead_predictions",[o]);eventMethods(s),s.TA=n,s.options=e,s.wrapper_el=r,s.list_el=o,s.custom_predictions=[],s._onDocumentClick=function(e){var t=e.target;if(!s.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===r||t===n.input_el)return;t=t.parentElement}s.hide()}},s.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(r),e.custom_address&&(_on(t=_create("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){s.showing_custom=!0,e.custom_address.getter(function(e){s.showing_custom=!1,e.place={scope:"custom"},e.formatted_address=_formattedAddress(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),s.setPredictions([],e),s.render(),s.select(e),s.emit("custom_address",[e]),s.hide()},function(){s.showing_custom=!1,s.emit("cancel-custom_address")})}),i.appendChild(t));var a=e.custom_provider_image||n.provider.license_img;a&&i.appendChild(_create(".-license",[_create("img",{src:a})])),(e.custom_address||a)&&r.appendChild(i)}function _selectDelta(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}TypeaheadPredictions.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),_on(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hide=function(){this.wrapper_el.style.display="none",this.is_hidden=!0,_off(document,"click",this._onDocumentClick,!0)},TypeaheadPredictions.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},TypeaheadPredictions.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,s=t.length;n<s;n++)_toggleClass(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},TypeaheadPredictions.prototype.selectPrevious=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,-1)},TypeaheadPredictions.prototype.selectNext=function(){this.loaded_predictions&&_selectDelta.call(this,this.loaded_predictions,1)},TypeaheadPredictions.prototype.setPredictions=function(e,t,n){var s=this;e&&(e=e.slice());var o=(e=e||s.predictions_data||[]).slice();s.options.keep_custom?s.custom_predictions.length&&(t&&s.custom_predictions.push(t),_push.apply(o,s.custom_predictions)):t&&o.push(t),s.predictions_data=e,s.loaded_predictions=o,n||s.select(s.selected&&0<=o.indexOf(s.selected)?s.selected:o[0]||null)},TypeaheadPredictions.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},TypeaheadPredictions.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},TypeaheadPredictions.prototype.disable=function(){this.is_disabled=!0,_addClass(this.wrapper_el,"_is-disabled")},TypeaheadPredictions.prototype.enable=function(){this.is_disabled=!1,_removeClass(this.wrapper_el,"_is-disabled")},TypeaheadPredictions.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,s,o,i=t.loaded_predictions||[],r=this.list_el,a=this.wrapper_el,c=r.children;function l(){t.is_disabled||t.select(this.prediction)}if(_toggleClass(a,"_has-predictions",t.predictions_data&&t.predictions_data.length),_toggleClass(a,"_has-custom_predictions",t.custom_predictions.length),i.length>c.length)for(n=0,s=i.length-c.length;n<s;n++)o=_create(".-prediction",{tabindex:"0"}),r.appendChild(o),_on(o,"click",l);for(n=0,s=i.length;n<s;n++)c[n].innerHTML=t.TA.provider.getPredictionHTML(i[n])||_address2Search(i[n]),c[n].prediction=i[n],_toggleClass(c[n],"_is-custom","custom"===i[n].place),_toggleClass(c[n],"_is-selected",i[n]===t.selected);if(i.length<c.length)for(;c[i.length];)r.removeChild(c[i.length])};var KEY_ENTER=13,KEY_UP=38,KEY_DOWN=40,KEY_ESC=27;function __trySearches(t,n,s){var o=t.shift();o&&n(o,function(e){e&&e[0]?s(e,o):__trySearches(t,n,s)},function(){__trySearches(t,n,s)})}function AddressTypeahead(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new GooglePlaceTypeahead(e.google).load())}AddressTypeahead.prototype.bind=function(o,t){var n=null,s=!1,i=null,r=null,a=null,c=null,l=null,d=eventMethods({get value(){return o.value},set value(e){o.value=e,v()},get address(){return n},set address(e){e&&e.place&&((n=e).place&&"custom"===e.place.scope?(_.addCustomPrediction(e),o.value=_address2Search(e),_.select(e)):(_.setPredictions([e.place]),o.value=_address2Search(e,!0),_.select(e.place)),h("change"))}});t=t||{};var u=this.focus_root,p=this.provider;"string"==typeof o&&(o=u.querySelector(o)),this.input_el=o;var _=new TypeaheadPredictions(this,t);function f(e){o.value=e}function h(e){d.emit(e,[o.value,n,s])}function m(e){if(a=null,n=e,c&&l){if(!e||!e.street_number)return void(n=null);f(_address2Search(n,!0,!1)),_.setPredictions(l,null,!0),c=l=null,u.activeElement===o&&_.show()}h("change")}var g=null;function y(){_.enable(),r&&(r.timeout&&clearTimeout(r.timeout),r=null)}function v(){if(o.value!==g){var e=r;if(y(),g=o.value,s=_numberTyped(o.value),!o.value)return i="",_.clear(),void m(null);var n=o.value;_.disable(),r={listeners:[],input_value:o.value,timeout:setTimeout(function(){p.getPredictions(o.value,function(e){if(_.render(e),e.length&&o.value===n&&r){var t=r.listeners;y(),t.forEach(_runListeners(e))}},function(){o.value===n&&y()})},e?t.debounce_duration||400:0)}}else u.activeElement===o&&_.show()}function e(){_.show(),n&&!n.street_number?(f(_formattedAddress(n,!0)),_cursorToNumberPosition(o,n)):n&&f(_address2Search(n,!0,!1))}function b(){r?r.listeners.push(b):a?a.push(b):(n&&!n.street_number?(f(_address2Search(n,!0,!0)),_cursorToNumberPosition(o,n),v()):(P(),_.hide()),t.onEnter instanceof Function&&t.onEnter(n))}function P(){r?r.listeners.push(P):a?a.push(P):(f(_formattedAddress(n,!0)),s=!1,h("change"))}return _.on("selected",function(e){if(!e)return m(null);var n,s;i=o.value,e.place&&"custom"===e.place.scope?m(e):(n=e,a=[],p.getAddress(n,function(e){if(o.value===i&&_.selected===n){var t=a;m(e),s instanceof Function&&s(e),t&&t.forEach(_runListeners([e]))}}))}),_on(o,"input",v),_on(o,"change",v),_on(o,"focus",e),_on(o,"click",e),_.on("cancel-custom_address",function(){o.focus()}),_on(o,"click",function(){_.show()}),o.addEventListener("keydown",function(e){if(!_.is_disabled)switch(e.keyCode!==KEY_ENTER&&_.show(),e.keyCode){case KEY_ESC:f(""),v();break;case KEY_ENTER:if(_.is_hidden)return;e.preventDefault(),b();break;case KEY_UP:e.preventDefault(),_.selectPrevious();break;case KEY_DOWN:e.preventDefault(),_.selectNext()}}),_on(o,"blur",_runDelayed(100,function(){P(),_.showing_custom||u.activeElement===o||_.hide()})),d.input=o,d.focus=function(){return o.focus(),d},o.value?v():t.try_searches&&__trySearches(t.try_searches,p.getPredictions.bind(p),function(e,t){_.select(e[0]),l=e,c=t}),d},module.exports=AddressTypeahead;