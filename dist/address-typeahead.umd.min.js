!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AddressTypeahead=t()}(this,function(){"use strict";var r=[].shift;function a(e){return e instanceof Array}function l(e){return"object"==typeof e&&null!==e}function P(t,n){return function(e){e.apply(n,t)}}function C(o){var s={},c={};return(o=o||{}).on=function(e,t){return s[e]=s[e]||[],s[e].push(t),o},o.once=function(e,t){return c[e]=c[e]||[],c[e].push(t),o},o.off=function(e,t){return s[e]&&function(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}(s[e],t),o},o.emit=function(e,t,n){var i=P(t,n);return s[e]&&s[e].forEach(i),c[e]&&c[e].splice(0).forEach(i),o},o}var s=Array.prototype.shift;function u(){var e,t,n,i,o=s.call(arguments);return"string"!=typeof o?(e=o,o=null):e=s.call(arguments),e instanceof Array?(n=e,e=null):t=s.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},i=t,function(e,t,n,i){var o,s=document.createElement(e||"div");if(t)for(o in t)s.setAttribute(o,t[o]);for(o in n)s[o]=n[o];return i&&i.forEach(function(e){s.appendChild(e)}),s}(o=(o||"").replace(/#([^\s.]+)/,function(e,t){return i.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return i.className=i.className?i.className+" "+t:t,""}),e,t,n)}var e,t="classList"in document.documentElement,n=t?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},i=t?function(e,t){e.classList.add(t)}:function(e,t){n(e,t)||(e.className+=" "+t)},o=t?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},d=t?((e=document.createElement("span")).classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}):function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function L(e,t,n,i){return e.addEventListener(t,n,i)}function c(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var p=0;c.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),i="__googleAPICallback__"+ ++p;return t.loading=!0,window[i]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+i,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},c.prototype.getPredictions=function(n,i,o){if("string"==typeof n&&(n=n.trim()),n){var s=this,c=s.predictions_cache;return c[n]?i(c[n]):s.load(function(){s.service.autocomplete.getPlacePredictions(function e(){for(var t,n=r.call(arguments),i=r.call(arguments);i;){if(typeof n!=typeof i&&(n=a(i)?[]:l(i)?{}:i),l(i))for(t in i)void 0===i[t]?n[t]=void 0:a(n[t])?[].push.apply(n[t],i[t]):l(n[t])?n[t]=e(n[t],i[t]):n[t]=i[t];i=r.call(arguments)}return n}({},s.options,{input:n,sessionToken:s.options.session_token||s.session_token}),function(e,t){t==s.predictions_OK?(c[n]=e,i instanceof Function&&i(e)):o instanceof Function&&o(t)})}),s}i instanceof Function&&i([])},c.prototype.getPredictionHTML=function(e){var t,n,i=0,o=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var c=0,r=e.matched_substrings.length;c<r;c++)t=e.matched_substrings[c].offset,n=e.matched_substrings[c].length,s+=o.substr(i,t-i).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+o.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",i=t+n;return s+=o.substr(i).replace(/^ | $/g,"&nbsp;")};var f="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function h(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function A(e,t,n){if(!e)return"";var i=e.sublocality||e.locality||e.city;return e.street+(h(e.street_number)||(t?", ":""))+h(!1!==n&&i!==e.street&&i)}function T(e,t,n,i){return e?e.street+h(e.street_number||(t?" ":""))+h(e.postcode?e.postcode+" ":"")+h(e.locality)+h(e.province!==e.locality&&e.province)+h(n&&e.region)+h(i&&e.country):""}function N(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}c.prototype.getAddress=function(n,i,o){var s=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(s[n.place_id])return i(s[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||f},function(e,t){"OK"===t?(s[n.place_id]=function(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var i={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(i.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),i}(e,n),i instanceof Function&&i(s[n.place_id])):o instanceof Function&&o(t)})},c.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var _=Array.prototype.push;function x(n,e){var t,i=this,o=u(".-predictions-list"),s=u(".-predictions-footer"),c=u(e.wrapper_selector||".apz-typeahead_predictions",[o]);C(i),i.TA=n,i.options=e,i.wrapper_el=c,i.list_el=o,i.custom_predictions=[],i._onDocumentClick=function(e){var t=e.target;if(!i.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===c||t===n.input_el)return;t=t.parentElement}i.hide()}},i.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(c),e.custom_address&&(L(t=u("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){i.showing_custom=!0,e.custom_address.getter(function(e){i.showing_custom=!1,e.place="custom",e.formatted_address=T(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),i.setPredictions([],e),i.render(),i.select(e),i.emit("custom_address",[e]),i.hide()},function(){i.showing_custom=!1,i.emit("cancel-custom_address")})}),s.appendChild(t));var r=e.custom_provider_image||n.provider.license_img;r&&s.appendChild(u(".-license",[u("img",{src:r})])),(e.custom_address||r)&&c.appendChild(s)}function m(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}x.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),L(document,"click",this._onDocumentClick,!0)},x.prototype.hide=function(){var e,t,n,i;this.wrapper_el.style.display="none",this.is_hidden=!0,e=document,t="click",n=this._onDocumentClick,i=!0,e.removeEventListener(t,n,i)},x.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},x.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,i=t.length;n<i;n++)d(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},x.prototype.selectPrevious=function(){this.loaded_predictions&&m.call(this,this.loaded_predictions,-1)},x.prototype.selectNext=function(){this.loaded_predictions&&m.call(this,this.loaded_predictions,1)},x.prototype.setPredictions=function(e,t,n){var i=this;e&&(e=e.slice());var o=(e=e||i.predictions_data||[]).slice();i.options.keep_custom?i.custom_predictions.length&&(t&&i.custom_predictions.push(t),_.apply(o,i.custom_predictions)):t&&o.push(t),i.predictions_data=e,i.loaded_predictions=o,n||i.select(i.selected&&0<=o.indexOf(i.selected)?i.selected:o[0]||null)},x.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},x.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},x.prototype.disable=function(){this.is_disabled=!0,i(this.wrapper_el,"_is-disabled")},x.prototype.enable=function(){this.is_disabled=!1,o(this.wrapper_el,"_is-disabled")},x.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,i,o,s=t.loaded_predictions||[],c=this.list_el,r=this.wrapper_el,a=c.children;function l(){t.is_disabled||t.select(this.prediction)}if(d(r,"_has-predictions",t.predictions_data&&t.predictions_data.length),d(r,"_has-custom_predictions",t.custom_predictions.length),s.length>a.length)for(n=0,i=s.length-a.length;n<i;n++)o=u(".-prediction",{tabindex:"0"}),c.appendChild(o),L(o,"click",l);for(n=0,i=s.length;n<i;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(s[n])||A(s[n]),a[n].prediction=s[n],d(a[n],"_is-custom","custom"===s[n].place),d(a[n],"_is-selected",s[n]===t.selected);if(s.length<a.length)for(;a[s.length];)c.removeChild(a[s.length])};function g(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new c(e.google).load())}return g.prototype.bind=function(o,s){var t=null,c=!1,r=null,a=null,l=null,n=null,i=null,u=C({get value(){return o.value},set value(e){o.value=e,b()},get address(){return t},set address(e){e&&e.place&&("custom"===(t=e).place?(f.addCustomPrediction(e),o.value=A(e),f.select(e)):(f.setPredictions([e.place]),o.value=A(e,!0),f.select(e.place)),_("change"))}});s=s||{};var d=this.focus_root,p=this.provider;"string"==typeof o&&(o=d.querySelector(o)),this.input_el=o;var f=new x(this,s);function h(e){o.value=e}function _(e){u.emit(e,[o.value,t,c])}function m(e){if(l=null,t=e,n&&i){if(!e||!e.street_number)return void(t=null);h(A(t,!0,!1)),f.setPredictions(i,null,!0),n=i=null,d.activeElement===o&&f.show()}_("change")}var e,g,v=null;function y(){f.enable(),a&&(a.timeout&&clearTimeout(a.timeout),a=null)}function b(){if(o.value!==v){var e,t,n=a;if(y(),v=o.value,e=o.value,t=e&&e.match(/.+?\w+[ ,]+(\d+)/),c=t?t[1]:null,!o.value)return r="",f.clear(),void m(null);var i=o.value;f.disable(),a={listeners:[],input_value:o.value,timeout:setTimeout(function(){p.getPredictions(o.value,function(e){if(f.render(e),e.length&&o.value===i&&a){var t=a.listeners;y(),t.forEach(P(e))}},function(){o.value===i&&y()})},n?s.debounce_duration||400:0)}}else d.activeElement===o&&f.show()}function w(){f.show(),t&&!t.street_number?(h(T(t,!0)),N(o,t)):t&&h(A(t,!0,!1))}function E(){a?a.listeners.push(E):l?l.push(E):(t&&!t.street_number?(h(A(t,!0,!0)),N(o,t),b()):(k(),f.hide()),s.onEnter instanceof Function&&s.onEnter(t))}function k(){a?a.listeners.push(k):l?l.push(k):(h(T(t,!0)),c=!1,_("change"))}return f.on("selected",function(e){if(!e)return m(null);var n,i;r=o.value,"custom"===e.place?m(e):(n=e,l=[],p.getAddress(n,function(e){if(o.value===r&&f.selected===n){var t=l;m(e),i instanceof Function&&i(e),t&&t.forEach(P([e]))}}))}),L(o,"input",b),L(o,"change",b),L(o,"focus",w),L(o,"click",w),f.on("cancel-custom_address",function(){o.focus()}),L(o,"click",function(){f.show()}),o.addEventListener("keydown",function(e){if(!f.is_disabled)switch(13!==e.keyCode&&f.show(),e.keyCode){case 27:h(""),b();break;case 13:if(f.is_hidden)return;e.preventDefault(),E();break;case 38:e.preventDefault(),f.selectPrevious();break;case 40:e.preventDefault(),f.selectNext()}}),L(o,"blur",(e=100,g=function(){k(),f.showing_custom||d.activeElement===o||f.hide()},function(){setTimeout(g,e)})),u.input=o,u.focus=function(){return o.focus(),u},o.value?b():s.try_searches&&function t(n,i,o){var s=n.shift();s&&i(s,function(e){e&&e[0]?o(e,s):t(n,i,o)},function(){t(n,i,o)})}(s.try_searches,p.getPredictions.bind(p),function(e,t){f.select(e[0]),i=e,n=t}),u},g});