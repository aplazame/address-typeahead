!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AddressTypeahead=t()}(this,function(){"use strict";var I=Date.now||function(){return(new Date).getTime()};var s=[].shift,r=function(e){return e instanceof Array},c=function(e){return"object"==typeof e&&null!==e};function $(e,t,n){for(var o=0,i=e.length;o<i;o++)if(t.call(n,e[o],o))return e[o]}function t(e){this.options=e||{},this.loading_listeners=[]}var i=0;t.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++i;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},t.prototype.getPredictions=function(e,o,i){if(e)return this.load(function(n){n.service.autocomplete.getPlacePredictions(function e(){for(var t,n=s.call(arguments),o=s.call(arguments);o;){if(typeof n!=typeof o&&(n=r(o)?[]:c(o)?{}:o),c(o))for(t in o)void 0===o[t]?n[t]=void 0:r(n[t])?[].push.apply(n[t],o[t]):c(n[t])?n[t]=e(n[t],o[t]):n[t]=o[t];o=s.call(arguments)}return n}({},n.options,{input:e,sessionToken:n.options.session_token}),function(e,t){t==n.predictions_OK?o instanceof Function&&o(e):i instanceof Function&&i(t)})});o instanceof Function&&o([])},t.prototype.getPredictionHTML=function(e){var t,n,o=0,i=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,c=e.matched_substrings.length;r<c;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,s+=i.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+i.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return s+=i.substr(o)};var e="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);t.prototype.getAddress=function(n,o,i){this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||e},function(e,t){"OK"===t?o instanceof Function&&o(function(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}(e,n)):i instanceof Function&&i(t)})},t.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var a=Array.prototype.shift;function z(){var e,t,n,o,i=a.call(arguments);return"string"!=typeof i?(e=i,i=null):e=a.call(arguments),e instanceof Array?(n=e,e=null):t=a.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},o=t,function(e,t,n,o){var i,s=document.createElement(e||"div");if(t)for(i in t)s.setAttribute(i,t[i]);for(i in n)s[i]=n[i];return o&&o.forEach(function(e){s.appendChild(e)}),s}(i=(i||"").replace(/#([^\s.]+)/,function(e,t){return o.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return o.className=o.className?o.className+" "+t:t,""}),e,t,n)}var n,o="classList"in document.documentElement,d=o?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},U=o?function(e,t){e.classList.add(t)}:function(e,t){d(e,t)||(e.className+=" "+t)},B=o?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},G=o?((n=document.createElement("span")).classList.toggle("test",!0),n.classList.toggle("test",!0),n.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}):function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function J(e,t,n){return e.addEventListener("click",t,n)}function Q(e){return e?", "+e:""}function V(e,t){if(!e)return"";var n=e.sublocality||e.locality||e.city;return e.street+(Q(e.street_number)||(t?", ":""))+Q(n!==e.street&&n)}function l(e){this.options=e||{},this.options.google&&(this.provider=new t(this.options.google).load())}return l.prototype.bind=function(s,e){var o,i,r,t=(i={},r={},(o=(o={})||{}).on=function(e,t){return i[e]=i[e]||[],i[e].push(t),o},o.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),o},o.off=function(e,t){return i[e]&&function(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}(i[e],t),o},o.emit=function(e,t,n){return i[e]&&i[e].forEach(function(e){e.apply(n,t)}),r[e]&&r[e].splice(0).forEach(function(e){e.apply(n,t)}),o},o),c=[],a={},d=(e=e||{}).focus_root||document,l=this.provider,u=!1,n=!1;"string"==typeof s&&(s=d.querySelector(s));var p,f,m,g,v,h,_,y,b,E,w,L,C,N=e.predictions_parent?"string"==typeof e.predictions_parent?d.querySelector(e.predictions_parent):e.predictions_parent:s.parentElement,A=z(".-predictions-list"),P=z(".-predictions-list._custom-list"),T=z(".-predictions-footer"),k=z(".apz-address-typeahead-predictions",[A,P]);function x(){var e=s.value&&s.value.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return e?e[1]:null}function F(){t.emit("change",[s.value,a.address,x()])}function O(){t.emit("blur",[s.value,a.address,x()])}function S(){var e,t,n;u||(!a.address||a.address.street_number||x()||(j([]),s.value=V(a.address,!0)),k.style.display="none",O(),e=document,t=D,n=!0,e.removeEventListener("click",t,n))}function D(e){var t=e.target;if(d.activeElement!==s){for(;t&&t!==document.body;){if(t===k||t===s)return;t=t.parentElement}S(),n=!1}}function R(e,t){var n=z(".-prediction._custom"),o=function(){K(),j([]),U(n,"_selected"),a.address=e,s.value=V(e),S()};return n.innerHTML=V(e),J(n,o),t&&o(),n}function j(e){var t,n,o,i=A.children;if(e&&(c=e),G(k,"_has_predictions",c.length),c.length>i.length)for(t=0,n=c.length-i.length;t<n;t++)A.appendChild((void 0,J(o=z(".-prediction"),function(){H(this.getAttribute("data-predition"),function(){var e=x();return a.address&&a.address.street_number?e&&Number(e)!==Number(a.address.street_number)?(d.activeElement!==s&&s.focus(),void O()):void S():(d.activeElement!==s&&s.focus(),void O())})}),o));for(t=0,n=c.length;t<n;t++)i[t].innerHTML=l.getPredictionHTML(c[t])||V(c[t]),i[t].setAttribute("data-predition",c[t].id),G(i[t],"_custom","custom"===c[t].place);if(c.length<i.length)for(;i[c.length];)A.removeChild(i[c.length])}function H(t,n){"string"==typeof t&&(t=$(c,function(e){return e.id===t})),t&&(K(),$(A.children,function(e){if(e.getAttribute("data-predition")===t.id)return U(e,"_selected"),!0}),a.prediction=t,!1!==n?l.getAddress(t,function(e){t===a.prediction&&(a.address=e,d.activeElement===s||!a.address||a.address.street_number||x()||(s.value=V(e,!0)),n instanceof Function&&n(),F())}):F())}function K(){var e,t,n=A.children;for(e=0,t=n.length;e<t;e++)B(n[e],"_selected");for(e=0,t=(n=P.children).length;e<t;e++)B(n[e],"_selected");delete a.prediction}function M(){if(a.address&&a.address.custom&&K(),delete a.address,!s.value)return j([]),K(),void F();l.getPredictions(s.value,function(e){j(e),c[0]&&H(c[0])})}k.style.display="none",e.custom_address&&(J(p=z("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),function(){u=!0,e.custom_address.getter(function(e){var t;u=!1,e.place="custom",e.formatted_address=(t=e)?t.street+Q(t.street_number)+Q(t.postcode+" "+t.locality)+Q(t.province)+Q(t.region)+Q(t.country):"",e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),U(P,"_has_addresses"),P.appendChild(R(e,!0)),j([]),s.value=V(e),F(),S()},function(){u=!1,s.focus()})}),T.appendChild(p)),l.license_img&&T.appendChild(z(".-license",[z("img",{src:l.license_img})])),N.appendChild(k),(e.custom_address||l.license_img)&&k.appendChild(T),f=s,v=M,h=e.debounce_duration,_=null,y=I(),b=function(e,t){v.apply(e,t),y=I(),_=setTimeout(function(){_=null},h)},h=h||400,m=function(){var e=this,t=arguments;!_||I()-y>h?b(e,t):(clearTimeout(_),_=setTimeout(function(){b(e,t)},h))},f.addEventListener("input",m,g),E=function(){var e;k.style.display="",a.address&&!a.address.street_number&&(e=a.address,setTimeout(function(){s.setSelectionRange(e.street.length+2,e.street.length+2)},10),setTimeout(function(){s.setSelectionRange(e.street.length+2,e.street.length+2)},100))},s.addEventListener("focus",E,w),J(s,function(){k.style.display=""}),J(document,D,!0),s.addEventListener("keydown",function(e){switch(e.keyCode){case 13:if("none"===k.style.display)return;!a.address||!a.address.street_number||x()&&Number(x())!==Number(a.address.street_number)?O():(e.preventDefault(),S());break;case 38:e.preventDefault(),a.prediction&&c&&H(c[c.indexOf(a.prediction)-1]);break;case 40:e.preventDefault(),a.prediction&&c&&H(c[c.indexOf(a.prediction)+1])}}),k.addEventListener("mousedown",function(e){n=!1}),L=function(){setTimeout(function(){d.activeElement!==s&&(n?n=!1:S())},100)},s.addEventListener("blur",L,C),t.input=s,t.focus=function(){return s.focus(),t},Object.defineProperty(t,"value",{get:function(){return s.value},set:function(e){s.value=e,M()}}),Object.defineProperty(t,"address",{get:function(){return a.address},set:function(e){e&&e.place&&("custom"===e.place?(U(P,"_has_addresses"),P.appendChild(R(e,!0)),j([]),s.value=V(e)):(s.value=V(e,!0),j([e.place]),H(e.place,!1)),a.address=e,F(),d.activeElement!==s&&S())}}),s.value&&M();var q=e.try_searches||[];return function t(){var n=q.shift();n?l.getPredictions(n,function(e){e&&e[0]?(j(e),H(e[0]),s.value=n):t()}):c=[]}(),t},l});