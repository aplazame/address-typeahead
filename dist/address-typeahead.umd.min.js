!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AddressTypeahead=t()}(this,function(){"use strict";var y=Date.now||function(){return(new Date).getTime()};var r=[].shift;function a(e){return e instanceof Array}function l(e){return"object"==typeof e&&null!==e}function w(t,n){return function(e){e.apply(n,t)}}function b(i){var s={},c={};return(i=i||{}).on=function(e,t){return s[e]=s[e]||[],s[e].push(t),i},i.once=function(e,t){return c[e]=c[e]||[],c[e].push(t),i},i.off=function(e,t){return s[e]&&function(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}(s[e],t),i},i.emit=function(e,t,n){var o=w(t,n);return s[e]&&s[e].forEach(o),c[e]&&c[e].splice(0).forEach(o),i},i}var s=Array.prototype.shift;function u(){var e,t,n,o,i=s.call(arguments);return"string"!=typeof i?(e=i,i=null):e=s.call(arguments),e instanceof Array?(n=e,e=null):t=s.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},o=t,function(e,t,n,o){var i,s=document.createElement(e||"div");if(t)for(i in t)s.setAttribute(i,t[i]);for(i in n)s[i]=n[i];return o&&o.forEach(function(e){s.appendChild(e)}),s}(i=(i||"").replace(/#([^\s.]+)/,function(e,t){return o.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return o.className=o.className?o.className+" "+t:t,""}),e,t,n)}var e,d="classList"in document.documentElement?((e=document.createElement("span")).classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}):function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function k(e,t,n,o){return e.addEventListener(t,n,o)}function t(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var i=0;t.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++i;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},t.prototype.getPredictions=function(n,o,i){if("string"==typeof n&&(n=n.trim()),n){var s=this,c=s.predictions_cache;return c[n]?o(c[n]):s.load(function(){s.service.autocomplete.getPlacePredictions(function e(){for(var t,n=r.call(arguments),o=r.call(arguments);o;){if(typeof n!=typeof o&&(n=a(o)?[]:l(o)?{}:o),l(o))for(t in o)void 0===o[t]?n[t]=void 0:a(n[t])?[].push.apply(n[t],o[t]):l(n[t])?n[t]=e(n[t],o[t]):n[t]=o[t];o=r.call(arguments)}return n}({},s.options,{input:n,sessionToken:s.options.session_token||s.session_token}),function(e,t){t==s.predictions_OK?(c[n]=e,o instanceof Function&&o(e)):i instanceof Function&&i(t)})}),s}o instanceof Function&&o([])},t.prototype.getPredictionHTML=function(e){var t,n,o=0,i=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var c=0,r=e.matched_substrings.length;c<r;c++)t=e.matched_substrings[c].offset,n=e.matched_substrings[c].length,s+=i.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+i.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return s+=i.substr(o)};var c="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function p(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function E(e,t,n){if(!e)return"";var o=e.sublocality||e.locality||e.city;return e.street+(p(e.street_number)||(t?", ":""))+p(!1!==n&&o!==e.street&&o)}function P(e,t,n,o){return e?e.street+p(e.street_number||(t?" ":""))+p(e.postcode+" "+e.locality)+p(e.province!==e.locality&&e.province)+p(n&&e.region)+p(o&&e.country):""}function C(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}t.prototype.getAddress=function(n,o,i){var s=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(s[n.place_id])return o(s[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||c},function(e,t){"OK"===t?(s[n.place_id]=function(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}(e,n),o instanceof Function&&o(s[n.place_id])):i instanceof Function&&i(t)})},t.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var f=Array.prototype.push;function T(n,e){var t,o=this,i=u(".-predictions-list"),s=u(".-predictions-footer"),c=u(e.wrapper_selector||".apz-typeahead_predictions",[i]);b(o),o.TA=n,o.options=e,o.wrapper_el=c,o.list_el=i,o.custom_predictions=[],o._onDocumentClick=function(e){var t=e.target;if(!o.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===c||t===n.input_el)return;t=t.parentElement}o.hide()}},o.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(c),e.license_img&&s.appendChild(u(".-license",[u("img",{src:e.license_img})])),e.custom_address&&(k(t=u("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){o.showing_custom=!0,e.custom_address.getter(function(e){o.showing_custom=!1,e.place="custom",e.formatted_address=P(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),o.setPredictions([],e),o.render(),o.select(e),o.emit("custom_address",[e])},function(){o.showing_custom=!1,o.emit("cancel-custom_address")})}),s.appendChild(t)),(e.custom_address||e.license_img)&&c.appendChild(s)}function n(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}T.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),k(document,"click",this._onDocumentClick,!0)},T.prototype.hide=function(){var e,t,n,o;this.wrapper_el.style.display="none",this.is_hidden=!0,e=document,t="click",n=this._onDocumentClick,o=!0,e.removeEventListener(t,n,o)},T.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},T.prototype.select=function(e){console.warn("TypeaheadPredictions.prototype.select",e);var t=this.list_el.children||[];this.selected=e;for(var n=0,o=t.length;n<o;n++)d(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},T.prototype.selectPrevious=function(){this.loaded_predictions&&n.call(this,this.loaded_predictions,-1)},T.prototype.selectNext=function(){this.loaded_predictions&&n.call(this,this.loaded_predictions,1)},T.prototype.setPredictions=function(e,t){var n=this;e&&(e=e.slice());var o=(e=e||n.predictions_data||[]).slice();n.options.keep_custom?n.custom_predictions.length&&(t&&n.custom_predictions.push(t),f.apply(o,n.custom_predictions)):t&&o.push(t),n.predictions_data=e,n.loaded_predictions=o,n.selected&&o.indexOf(n.selected)<0&&n.select(null)},T.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},T.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},T.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,o,i,s=t.loaded_predictions||[],c=this.list_el,r=this.wrapper_el,a=c.children;function l(){t.select(this.prediction)}if(d(r,"_has-predictions",t.predictions_data&&t.predictions_data.length),d(r,"_has-custom_predictions",t.custom_predictions.length),s.length>a.length)for(n=0,o=s.length-a.length;n<o;n++)i=u(".-prediction",{tabindex:"0"}),c.appendChild(i),k(i,"click",l);for(n=0,o=s.length;n<o;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(s[n])||E(s[n]),a[n].prediction=s[n],d(a[n],"_is-custom","custom"===s[n].place),d(a[n],"_is-selected",s[n]===t.selected);if(s.length<a.length)for(;a[s.length];)c.removeChild(a[s.length])};function o(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new t(e.google).load())}return o.prototype.bind=function(o,e){var t=null,i=!1,s=null,c=null,n=b({get value(){return o.value},set value(e){o.value=e,f()},get address(){return t},set address(e){e&&e.place&&("custom"===(t=e).place?(l.addCustomPrediction(e),o.value=E(e)):(l.setPredictions([e.place]),o.value=E(e,!0)),l.select(e),u("change"))}});e=e||{};var r=this.focus_root,a=this.provider;"string"==typeof o&&(o=r.querySelector(o)),this.input_el=o;var l=new T(this,e);function u(e){n.emit(e,[o.value,t,i])}function d(e){t=e,u("change")}var p=null;function f(){if(o.value!==p){var e,t;if(p=o.value,e=o.value,t=e&&e.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/),i=t?t[1]:null,!o.value)return s="",l.clear(),d(null);var n=o.value;a.getPredictions(o.value,function(e){l.render(e),e.length&&o.value===n&&e[0]&&e.indexOf(l.selected)<0&&l.select(e[0])})}else r.activeElement===o&&l.show()}l.on("selected",function(e){if(!e)return d(null);var t,n;s=o.value,"custom"===e.place?d(e):(t=e,c=[],a.getAddress(t,function(e){o.value===s&&l.selected===t&&(d(e),n instanceof Function&&n(e),c.forEach(w([e])),c=null)}))});var h,m,_=function(n,o){var i=null,s=y();function c(e,t){n.apply(e,t),s=y(),i=setTimeout(function(){i=null},o)}return o=o||400,function(){var e=this,t=arguments;!i||y()-s>o?c(e,t):(clearTimeout(i),i=setTimeout(function(){c(e,t)},o))}}(f,e.debounce_duration);function g(){l.show(),t&&!t.street_number?(o.value=P(t,!0),C(o,t)):t&&(o.value=E(t,!0,!1)),f()}function v(e){o.value=P(e,!0)}return k(o,"input",_),k(o,"change",_),k(o,"focus",g),k(o,"click",g),l.on("cancel-custom_address",function(){o.focus()}),k(o,"click",function(){l.show()}),o.addEventListener("keydown",function(e){switch(13!==e.keyCode&&l.show(),e.keyCode){case 13:if(l.is_hidden)return;e.preventDefault(),t&&!t.street_number?(o.value=E(t,!0,!0),C(o,t),f()):(c?c.push(v):v(t),l.hide());break;case 38:e.preventDefault(),l.selectPrevious();break;case 40:e.preventDefault(),l.selectNext()}}),k(o,"blur",(h=100,m=function(){c?c.push(v):v(t),l.showing_custom||r.activeElement===o||l.hide()},function(){setTimeout(m,h)})),n.input=o,n.focus=function(){return o.focus(),n},o.value?f():e.try_searches&&function t(n,o,i){var s=n.shift();s&&o(s,function(e){e&&e[0]?i(e,s):t(n,o,i)})}(e.try_searches,a.getPredictions.bind(a),function(e,t){l.setPredictions(e),l.select(e[0]),o.value=t}),n},o});