!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AddressTypeahead=t()}(this,function(){"use strict";var c=[].shift;function a(e){return e instanceof Array}function l(e){return"object"==typeof e&&null!==e}function E(t,n){return function(e){e.apply(n,t)}}function P(o){var s={},r={};return(o=o||{}).on=function(e,t){return s[e]=s[e]||[],s[e].push(t),o},o.once=function(e,t){return r[e]=r[e]||[],r[e].push(t),o},o.off=function(e,t){return s[e]&&function(e,t){for(var n=e.length-1;0<=n;n--)e[n]===t&&e.splice(n,1)}(s[e],t),o},o.emit=function(e,t,n){var i=E(t,n);return s[e]&&s[e].forEach(i),r[e]&&r[e].splice(0).forEach(i),o},o}var s=Array.prototype.shift;function u(){var e,t,n,i,o=s.call(arguments);return"string"!=typeof o?(e=o,o=null):e=s.call(arguments),e instanceof Array?(n=e,e=null):t=s.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},i=t,function(e,t,n,i){var o,s=document.createElement(e||"div");if(t)for(o in t)s.setAttribute(o,t[o]);for(o in n)s[o]=n[o];return i&&i.forEach(function(e){s.appendChild(e)}),s}(o=(o||"").replace(/#([^\s.]+)/,function(e,t){return i.id=t,""}).replace(/\.([^\s.]+)/g,function(e,t){return i.className=i.className?i.className+" "+t:t,""}),e,t,n)}var e,d="classList"in document.documentElement?((e=document.createElement("span")).classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}):function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};function C(e,t,n,i){return e.addEventListener(t,n,i)}function t(e){this.options=e||{},this.loading_listeners=[],this.addresses_cache={},this.predictions_cache={}}var o=0;t.prototype.load=function(e){var t=this;if(t.loaded)return e(t);if(!t.loading){var n=window.document.createElement("script"),i="__googleAPICallback__"+ ++o;return t.loading=!0,window[i]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.session_token=new t.places.AutocompleteSessionToken,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+i,window.document.head.appendChild(n),this}t.loading_listeners.push(e)},t.prototype.getPredictions=function(n,i,o){if("string"==typeof n&&(n=n.trim()),n){var s=this,r=s.predictions_cache;return r[n]?i(r[n]):s.load(function(){s.service.autocomplete.getPlacePredictions(function e(){for(var t,n=c.call(arguments),i=c.call(arguments);i;){if(typeof n!=typeof i&&(n=a(i)?[]:l(i)?{}:i),l(i))for(t in i)void 0===i[t]?n[t]=void 0:a(n[t])?[].push.apply(n[t],i[t]):l(n[t])?n[t]=e(n[t],i[t]):n[t]=i[t];i=c.call(arguments)}return n}({},s.options,{input:n,sessionToken:s.options.session_token||s.session_token}),function(e,t){t==s.predictions_OK?(r[n]=e,i instanceof Function&&i(e)):o instanceof Function&&o(t)})}),s}i instanceof Function&&i([])},t.prototype.getPredictionHTML=function(e){var t,n,i=0,o=e.description,s="";if(!e.matched_substrings)return e.formatted_address;for(var r=0,c=e.matched_substrings.length;r<c;r++)t=e.matched_substrings[r].offset,n=e.matched_substrings[r].length,s+=o.substr(i,t-i).replace(/^ | $/g,"&nbsp;"),s+="<strong>"+o.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",i=t+n;return s+=o.substr(i)};var r="address_component, adr_address, alt_id, formatted_address, geometry, icon, id, name, permanently_closed, photo, place_id, plus_code, scope, type, url, utc_offset, vicinity".split(/ *, */);function p(e){return e?("string"==typeof e&&(e=e.trim()),", "+e):""}function A(e,t,n){if(!e)return"";var i=e.sublocality||e.locality||e.city;return e.street+(p(e.street_number)||(t?", ":""))+p(!1!==n&&i!==e.street&&i)}function T(e,t,n,i){return e?e.street+p(e.street_number||(t?" ":""))+p(e.postcode+" "+e.locality)+p(e.province!==e.locality&&e.province)+p(n&&e.region)+p(i&&e.country):""}function L(e,t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}t.prototype.getAddress=function(n,i,o){var s=this.addresses_cache;if(!n||!n.place_id)throw new TypeError("prediction is not a valid prediction");if(s[n.place_id])return i(s[n.place_id]);this.service.place.getDetails({placeId:n.place_id,fields:this.options.place_fields||r},function(e,t){"OK"===t?(s[n.place_id]=function(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var i={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(i.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),i}(e,n),i instanceof Function&&i(s[n.place_id])):o instanceof Function&&o(t)})},t.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var f=Array.prototype.push;function F(n,e){var t,i=this,o=u(".-predictions-list"),s=u(".-predictions-footer"),r=u(e.wrapper_selector||".apz-typeahead_predictions",[o]);P(i),i.TA=n,i.options=e,i.wrapper_el=r,i.list_el=o,i.custom_predictions=[],i._onDocumentClick=function(e){var t=e.target;if(!i.showing_custom&&n.focus_root.activeElement!==n.input_el){for(;t&&t!==document.body;){if(t===r||t===n.input_el)return;t=t.parentElement}i.hide()}},i.hide(),(e.predictions_parent?"string"==typeof e.predictions_parent?n.focus_root.querySelector(e.predictions_parent):e.predictions_parent:n.input_el.parentElement).appendChild(r),e.custom_address&&(C(t=u("button.-custom-address",{type:"button"},{textContent:e.custom_address.label}),"click",function(){i.showing_custom=!0,e.custom_address.getter(function(e){i.showing_custom=!1,e.place="custom",e.formatted_address=T(e),e.url="https://maps.google.com/?q="+encodeURIComponent(e.formatted_address),i.setPredictions([],e),i.render(),i.select(e),i.emit("custom_address",[e]),i.hide()},function(){i.showing_custom=!1,i.emit("cancel-custom_address")})}),s.appendChild(t));var c=e.custom_provider_image||n.provider.license_img;c&&s.appendChild(u(".-license",[u("img",{src:c})])),(e.custom_address||c)&&r.appendChild(s)}function n(e,t){var n=e.indexOf(this.selected);0<=n&&e[n+t]&&this.select(e[n+t])}F.prototype.show=function(e){this.wrapper_el.style.display="",(this.is_hidden=!1)!==e&&this.render(),C(document,"click",this._onDocumentClick,!0)},F.prototype.hide=function(){var e,t,n,i;this.wrapper_el.style.display="none",this.is_hidden=!0,e=document,t="click",n=this._onDocumentClick,i=!0,e.removeEventListener(t,n,i)},F.prototype.hasFocus=function(){var e=this.TA.focus_root.activeElement;return e===this.wrapper_el||this.wrapper_el.contains(e)},F.prototype.select=function(e){var t=this.list_el.children||[];this.selected=e;for(var n=0,i=t.length;n<i;n++)d(t[n],"_is-selected",t[n].prediction===e);this.emit("selected",[e])},F.prototype.selectPrevious=function(){this.loaded_predictions&&n.call(this,this.loaded_predictions,-1)},F.prototype.selectNext=function(){this.loaded_predictions&&n.call(this,this.loaded_predictions,1)},F.prototype.setPredictions=function(e,t){var n=this;e&&(e=e.slice());var i=(e=e||n.predictions_data||[]).slice();n.options.keep_custom?n.custom_predictions.length&&(t&&n.custom_predictions.push(t),f.apply(i,n.custom_predictions)):t&&i.push(t),n.predictions_data=e,n.loaded_predictions=i,n.select(n.selected&&0<=i.indexOf(n.selected)?n.selected:i[0]||null)},F.prototype.clear=function(e){e&&this.custom_predictions.splice(0),this.render([])},F.prototype.addCustomPrediction=function(e){this.custom_predictions.push(e),this.setPredictions()},F.prototype.render=function(e){var t=this;e&&t.setPredictions(e);var n,i,o,s=t.loaded_predictions||[],r=this.list_el,c=this.wrapper_el,a=r.children;function l(){t.select(this.prediction)}if(d(c,"_has-predictions",t.predictions_data&&t.predictions_data.length),d(c,"_has-custom_predictions",t.custom_predictions.length),s.length>a.length)for(n=0,i=s.length-a.length;n<i;n++)o=u(".-prediction",{tabindex:"0"}),r.appendChild(o),C(o,"click",l);for(n=0,i=s.length;n<i;n++)a[n].innerHTML=t.TA.provider.getPredictionHTML(s[n])||A(s[n]),a[n].prediction=s[n],d(a[n],"_is-custom","custom"===s[n].place),d(a[n],"_is-selected",s[n]===t.selected);if(s.length<a.length)for(;a[s.length];)r.removeChild(a[s.length])};function i(e){e=e||{},this.options=e,this.focus_root=e.focus_root||document,e.google&&(this.provider=new t(e.google).load())}return i.prototype.bind=function(o,s){var t=null,r=!1,c=null,a=null,l=null,n=null,i=P({get value(){return o.value},set value(e){o.value=e,y()},get address(){return t},set address(e){e&&e.place&&("custom"===(t=e).place?(p.addCustomPrediction(e),o.value=A(e),p.select(e)):(p.setPredictions([e.place]),o.value=A(e,!0),p.select(e.place)),h("change"))}});s=s||{};var u=this.focus_root,d=this.provider;"string"==typeof o&&(o=u.querySelector(o)),this.input_el=o;var p=new F(this,s);function f(e){o.value=e}function h(e){i.emit(e,[o.value,t,r])}function m(e){if(l=null,t=e,n){if(!e||!e.street_number)return p.clear(),void(t=null);f(A(t,!0,!1)),n=null}h("change")}var e,_,g=null;function v(){a&&(a.timeout&&clearTimeout(a.timeout),a=null)}function y(){if(o.value!==g){var e,t,n=a;if(v(),g=o.value,e=o.value,t=e&&e.match(/.+?\w+[ ,]+(\d+)/),r=t?t[1]:null,!o.value)return c="",p.clear(),void m(null);var i=o.value;a={listeners:[],input_value:o.value,timeout:setTimeout(function(){d.getPredictions(o.value,function(e){if(p.render(e),e.length&&o.value===i&&a){var t=a.listeners;v(),t.forEach(E(e))}},function(){o.value===i&&v()})},n?s.debounce_duration||400:0)}}else u.activeElement===o&&p.show()}function w(){p.show(),t&&!t.street_number?(f(T(t,!0)),L(o,t)):t&&f(A(t,!0,!1))}function b(){a?a.listeners.push(b):l?l.push(b):(t&&!t.street_number?(f(A(t,!0,!0)),L(o,t),y()):(k(),p.hide()),s.onEnter instanceof Function&&s.onEnter(t))}function k(){a?a.listeners.push(k):l?l.push(k):(f(T(t,!0)),r=!1,h("change"))}return p.on("selected",function(e){if(!e)return m(null);var n,i;c=o.value,"custom"===e.place?m(e):(n=e,l=[],d.getAddress(n,function(e){if(o.value===c&&p.selected===n){var t=l;m(e),i instanceof Function&&i(e),t&&t.forEach(E([e]))}}))}),C(o,"input",y),C(o,"change",y),C(o,"focus",w),C(o,"click",w),p.on("cancel-custom_address",function(){o.focus()}),C(o,"click",function(){p.show()}),o.addEventListener("keydown",function(e){switch(13!==e.keyCode&&p.show(),e.keyCode){case 27:f(""),y();break;case 13:if(p.is_hidden)return;e.preventDefault(),b();break;case 38:e.preventDefault(),p.selectPrevious();break;case 40:e.preventDefault(),p.selectNext()}}),C(o,"blur",(e=100,_=function(){k(),p.showing_custom||u.activeElement===o||p.hide()},function(){setTimeout(_,e)})),i.input=o,i.focus=function(){return o.focus(),i},o.value?y():s.try_searches&&function t(n,i,o){var s=n.shift();s&&i(s,function(e){e&&e[0]?o(e,s):t(n,i,o)})}(s.try_searches,d.getPredictions.bind(d),function(e,t){p.setPredictions(e),p.select(e[0]),n=t}),i},i});