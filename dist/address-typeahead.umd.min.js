!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.AddressTypeahead=t()}(this,function(){"use strict";function e(){for(var t,n=u.call(arguments),o=u.call(arguments);o;){if(typeof n!=typeof o&&(n=d(o)?[]:l(o)?{}:o),l(o))for(t in o)void 0===o[t]?n[t]=void 0:d(n[t])?[].push.apply(n[t],o[t]):l(n[t])?n[t]=e(n[t],o[t]):n[t]=o[t];o=u.call(arguments)}return n}function t(e,t,n){for(var o=0,i=e.length;o<i;o++)if(t.call(n,e[o],o))return e[o]}function n(e){this.options=e,this.loading_listeners=[]}function o(){var e,t,n,o=p.call(arguments);return"string"!=typeof o?(e=o,o=null):e=p.call(arguments),e instanceof Array?(n=e,e=null):t=p.call(arguments),t instanceof Array?(n=t,t={}):t=t||{},o=function(e,t){return(e||"").replace(/#([^\s.]+)/,function(e,n){return t.id=n,""}).replace(/\.([^\s.]+)/g,function(e,n){return t.className=t.className?t.className+" "+n:n,""})}(o,t),function(e,t,n,o){var i,r=document.createElement(e||"div");if(t)for(i in t)r.setAttribute(i,t[i]);for(i in n)r[i]=n[i];return o&&o.forEach(function(e){r.appendChild(e)}),r}(o,e,t,n)}function i(e,t,n){return e.addEventListener("click",t,n)}function r(e){return e?", "+e:""}function s(e,t){if(!e)return"";var n=e.sublocality||e.locality||e.city;return e.street+(r(e.street_number)||(t?", ":""))+r(n!==e.street&&n)}function c(e){this.options=e||{},this.options.google&&(this.provider=new n(this.options.google).load())}var a=Date.now||function(){return(new Date).getTime()},u=[].shift,d=function(e){return e instanceof Array},l=function(e){return"object"==typeof e&&null!==e},f=0;n.prototype.load=function(e){var t=this;if(t.loaded)return e(t);{if(!t.loading){var n=window.document.createElement("script"),o="__googleAPICallback__"+ ++f;return t.loading=!0,window[o]=function(){t.places=window.google.maps.places,t.predictions_OK=window.google.maps.places.PlacesServiceStatus.OK,t.service={autocomplete:new t.places.AutocompleteService,place:new t.places.PlacesService(document.createElement("div"))},delete t.loading,t.loaded=!0,t.loading_listeners.splice(0).forEach(function(e){e(t)})},n.src="https://maps.googleapis.com/maps/api/js?key="+this.options.app_key+"&libraries=places&callback="+o,window.document.head.appendChild(n),this}t.loading_listeners.push(e)}},n.prototype.getPredictions=function(t,n,o){if(t)return this.load(function(i){i.service.autocomplete.getPlacePredictions(e({},i.options,{input:t}),function(e,t){t==i.predictions_OK?n instanceof Function&&n(e):o instanceof Function&&o(t)})});n instanceof Function&&n([])},n.prototype.getPredictionHTML=function(e){var t,n,o=0,i=e.description,r="";if(!e.matched_substrings)return e.formatted_address;for(var s=0,c=e.matched_substrings.length;s<c;s++)t=e.matched_substrings[s].offset,n=e.matched_substrings[s].length,r+=i.substr(o,t-o).replace(/^ | $/g,"&nbsp;"),r+="<strong>"+i.substr(t,n).replace(/^ | $/g,"&nbsp;")+"</strong>",o=t+n;return r+=i.substr(o)},n.prototype.getAddress=function(e,t,n){this.service.place.getDetails(e,function(e,o){"OK"===o?t instanceof Function&&t(function(e,t){var n={};e.address_components.forEach(function(e){n[e.types[0]]=e.long_name});var o={street:n.route||e.name||"",street_number:Number(n.street_number),postcode:n.postal_code||"",locality:n.locality,sublocality:n.sublocality_level_1,province:n.administrative_area_level_2,region:n.administrative_area_level_1,country:n.country,formatted_address:e.formatted_address,url:e.url,place:e,_fields:n,_prediction:t};return e.geometry&&e.geometry.location&&(o.location={type:"Point",coordinates:[e.geometry.location.lng instanceof Function?e.geometry.location.lng():e.geometry.location.lng,e.geometry.location.lat instanceof Function?e.geometry.location.lat():e.geometry.location.lat]}),o}(e)):n instanceof Function&&n(o)})},n.prototype.license_img="https://developers.google.com/places/documentation/images/powered-by-google-on-white.png?hl=es-419";var p=Array.prototype.shift,m="classList"in document.documentElement,g=m?function(e,t){return e.classList.contains(t)}:function(e,t){return new RegExp("\\b"+(t||"")+"\\b","").test(e.className)},v=m?function(e,t){e.classList.add(t)}:function(e,t){g(e,t)||(e.className+=" "+t)},h=m?function(e,t){e.classList.remove(t)}:function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")},y=m?function(){var e=document.createElement("span");return e.classList.toggle("test",!0),e.classList.toggle("test",!0),e.classList.contains("test")?function(e,t,n){e.classList.toggle(t,n)}:function(e,t,n){(n=void 0===n?!e.classList.contains(t):n)?e.classList.add(t):e.classList.remove(t)}}():function(e,t){e.className=e.className.replace(new RegExp("\\s*"+t+"\\s*","g")," ")};return c.prototype.bind=function(e,n){function c(){var t=e.value&&e.value.match(/.*?, *(\d+) *(,.*?)?$|^.*? \d+/);return t?t[1]:null}function u(){w.emit("change",[e.value,C.address,c()])}function d(){w.emit("blur",[e.value,C.address,c()])}function l(){P||(!C.address||C.address.street_number||c()||(m([]),e.value=s(C.address,!0)),O.style.display="none",d(),function(e,t,n){e.removeEventListener("click",t,n)}(document,f,!0))}function f(t){var n=t.target;if(document.activeElement!==e){for(;n&&n!==document.body;){if(n===O||n===e)return;n=n.parentElement}l(),T=!1}}function p(t,n){var r=o(".-prediction._custom"),c=function(){_(),m([]),v(r,"_selected"),C.address=t,e.value=s(t),l()};return r.innerHTML=s(t),i(r,c),n&&c(),r}function m(t){var n,r,a=k.children;if(t&&(L=t),y(O,"_has_predictions",L.length),L.length>a.length)for(n=0,r=L.length-a.length;n<r;n++)k.appendChild(function(){var t=o(".-prediction");return i(t,function(){g(this.getAttribute("data-predition"),function(){var t=c();return C.address&&C.address.street_number?t&&Number(t)!==Number(C.address.street_number)?(document.activeElement!==e&&e.focus(),void d()):void l():(document.activeElement!==e&&e.focus(),void d())})}),t}());for(n=0,r=L.length;n<r;n++)a[n].innerHTML=A.getPredictionHTML(L[n])||s(L[n]),a[n].setAttribute("data-predition",L[n].id),y(a[n],"_custom","custom"===L[n].place);if(L.length<a.length)for(;a[L.length];)k.removeChild(a[L.length])}function g(n,o){"string"==typeof n&&(n=t(L,function(e){return e.id===n})),n&&(_(),t(k.children,function(e){if(e.getAttribute("data-predition")===n.id)return v(e,"_selected"),!0}),C.prediction=n,!1!==o?A.getAddress(n,function(t){n===C.prediction&&(C.address=t,document.activeElement===e||!C.address||C.address.street_number||c()||(e.value=s(t,!0)),o instanceof Function&&o(),u())}):u())}function _(){var e,t,n=k.children;for(e=0,t=n.length;e<t;e++)h(n[e],"_selected");for(e=0,t=(n=x.children).length;e<t;e++)h(n[e],"_selected");delete C.prediction}function b(){if(C.address&&C.address.custom&&_(),delete C.address,!e.value)return m([]),_(),void u();A.getPredictions(e.value,function(e){m(e),L[0]&&g(L[0])})}function E(){var t=S.shift();t?A.getPredictions(t,function(n){n&&n[0]?(m(n),g(n[0]),e.value=t):E()}):L=[]}var w=function(e){var t={},n={};return e=e||{},e.on=function(n,o){return t[n]=t[n]||[],t[n].push(o),e},e.once=function(t,o){return n[t]=n[t]||[],n[t].push(o),e},e.off=function(n,o){return t[n]&&function(e,t){for(var n=e.length-1;n>=0;n--)e[n]===t&&e.splice(n,1)}(t[n],o),e},e.emit=function(o,i,r){return t[o]&&t[o].forEach(function(e){e.apply(r,i)}),n[o]&&n[o].splice(0).forEach(function(e){e.apply(r,i)}),e},e}({}),L=[],C={};n=n||{},"string"==typeof e&&(e=document.querySelector(e));var N=n.predictions_parent?"string"==typeof n.predictions_parent?document.querySelector(n.predictions_parent):n.predictions_parent:e.parentElement,A=this.provider,P=!1,T=!1,k=o(".-predictions-list"),x=o(".-predictions-list._custom-list"),F=o(".-predictions-footer"),O=o(".apz-address-typeahead-predictions",[k,x]);O.style.display="none",n.custom_address&&function(){var t=o("button.-custom-address",{type:"button"},{textContent:n.custom_address.label});i(t,function(){P=!0,n.custom_address.getter(function(t){P=!1,t.place="custom",t.formatted_address=function(e){return e?e.street+r(e.street_number)+r(e.postcode+" "+e.locality)+r(e.province)+r(e.region)+r(e.country):""}(t),t.url="https://maps.google.com/?q="+encodeURIComponent(t.formatted_address),v(x,"_has_addresses"),x.appendChild(p(t,!0)),m([]),e.value=s(t),u(),l()},function(){P=!1,e.focus()})}),F.appendChild(t)}(),A.license_img&&F.appendChild(o(".-license",[o("img",{src:A.license_img})])),N.appendChild(O),(n.custom_address||A.license_img)&&O.appendChild(F),function(e,t,n){e.addEventListener("input",t,n)}(e,function(e,t){var n=null,o=a(),i=function(i,r){e.apply(i,r),o=a(),n=setTimeout(function(){n=null},t)};return t=t||400,function(){var e=this,r=arguments;!n||a()-o>t?i(e,r):(clearTimeout(n),n=setTimeout(function(){i(e,r)},t))}}(b)),function(e,t,n){e.addEventListener("focus",t,n)}(e,function(){O.style.display="",C.address&&!C.address.street_number&&function(t){setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},10),setTimeout(function(){e.setSelectionRange(t.street.length+2,t.street.length+2)},100)}(C.address)}),i(e,function(){O.style.display=""}),i(document,f,!0),e.addEventListener("keydown",function(e){switch(e.keyCode){case 13:if("none"===O.style.display)return;!C.address||!C.address.street_number||c()&&Number(c())!==Number(C.address.street_number)?d():(e.preventDefault(),l());break;case 38:e.preventDefault(),C.prediction&&L&&g(L[L.indexOf(C.prediction)-1]);break;case 40:e.preventDefault(),C.prediction&&L&&g(L[L.indexOf(C.prediction)+1])}}),O.addEventListener("mousedown",function(e){T=!1}),function(e,t,n){e.addEventListener("blur",t,n)}(e,function(){setTimeout(function(){document.activeElement!==e&&(T?T=!1:l())},100)}),w.input=e,w.focus=function(){return e.focus(),w},Object.defineProperty(w,"value",{get:function(){return e.value},set:function(t){e.value=t,b()}}),Object.defineProperty(w,"address",{get:function(){return C.address},set:function(t){t&&t.place&&("custom"===t.place?(v(x,"_has_addresses"),x.appendChild(p(t,!0)),m([]),e.value=s(t)):(e.value=s(t,!0),m([t.place]),g(t.place,!1)),C.address=t,u(),document.activeElement!==e&&l())}}),e.value&&b();var S=n.try_searches||[];return E(),w},c});