<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Demo Typeahead</title>

    <script src="./address-typeahead.js"></script>
    <style rel="stylesheet">

      main {
        display: block;
        width: 960px;
        max-width: 100%;
        margin: 8px auto;
        padding: 8px
      }

      * {
        box-sizing: border-box;
      }

      .hide-submit {
        display: block;
        width: 0;
        height: 0;
        overflow: hidden;
        opacity: 0;
      }

      pre, code {
        font-family: Consolas, Courier, monospace;
        color: #333;
        background: rgb(250, 250, 250);
      }

      .code {
        padding: 1em;
        border: 1px solid #eee;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .typeahead-wrapper {
        position: relative;
      }

      .typeahead-predictions {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        border: 1px solid #ccc;
        background: white;
      }

      .typeahead-predictions .predictions .prediction {
        padding: 8px;
        border-left: 4px solid transparent;
      }
        .typeahead-predictions .predictions .prediction:hover {
          background: #f9f9f9;
          cursor: pointer;
        }

        .typeahead-predictions .predictions .prediction.selected {
          border-left-color: #444;
        }

      .typeahead-predictions .predictions .prediction + .prediction {
        border-top: 1px solid #ddd;
      }

      .typeahead-predictions > .typeahead-footer {
        padding: 4px;
        text-align: right;
        border-top: 1px solid #eee;
      }

      .typeahead-predictions > .typeahead-footer img.google-license {
        vertical-align: middle;
        width: 120px;
      }

      #custom-address-form {
        display: block; position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.4);
        text-align: center;
      }
      #custom-address-form::before {
        display: inline-block;
        vertical-align: top;
      }
      #custom-address-form .modal {
        display: inline-block;
        margin: 64px 0;
        width: 100%;
        max-width: 400px;
        text-align: left;
        background: whitesmoke;
        padding: 16px;
      }

      #custom-address-form label, #custom-address-form input {
        display: block;
      }

      #custom-address-form label + label {
        margin-top: 8px;
      }

      #custom-address-form input {
        width: 100%;
        height: 40px;
        padding: 0 8px;
      }

      #custom-address-form .submit-wrapper {
        text-align: center;
        margin-top: 16px;
      }

      #custom-address-form .submit-wrapper button {
        height: 40px;
        padding: 0 8px;
        width: 100%;
      }

    </style>

    <link rel="stylesheet" href="https://unpkg.com/purecss@0.6.2/build/pure-min.css" integrity="sha384-UQiGfs9ICog+LwheBSRCt1o5cbyKIHbwjWscjemyBMT9YCUMZffs6UqUTd0hObXD" crossorigin="anonymous">
  </head>
  <body>
    <main>
      <div>
        <form action="javascript:console.log('gogogo!');" class="pure-form pure-form-stacked">
          <div class="pure-g">
            <input class="pure-u-1" type="text" placeholder="Google Maps API key" required></input>
            <div class="pure-u-1 text validation-message" style="color: firebrick"></div>
            <input class="pure-u-1" type="search" placeholder="Buscar dirección" autofocus required></input>
          </div>

          <div class="hide-submit">
            <button type="submit"></button>
          </div>
        </form>
        <div class="typeahead-wrapper"></div>
        <pre class="code"></pre>

        <form id="custom-address-form" style="display: none">
          <div class="modal">
            <label class="input-wrapper">
              <div>Calle</div>
              <input name="street" required value="Evergreen Terrace"></input>
            </label>
            <label class="input-wrapper">
              <div>Número</div>
              <input name="street_number" pattern="\d+" required value="742"></input>
            </label>
            <label class="input-wrapper">
              <div>Código postal</div>
              <input name="postcode" pattern="\d{5}" required value="12345"></input>
            </label>
            <label class="input-wrapper">
              <div>Localidad</div>
              <input name="locality" required value="Springfield"></input>
            </label>
            <label class="input-wrapper">
              <div>Ciudad</div>
              <input name="city" required value="Springfield"></input>
            </label>
            <label class="input-wrapper">
              <div>Estado</div>
              <input name="state" required value="Takoma del Norte"></input>
            </label>
            <div class="submit-wrapper">
              <button type="submit">Añadir</button>
            </div>
          </div>
        </form>
      </div>
    </main>
    <script>
      var qs = (function () {
        var qs = {},
            search = location.href.split('?')[1];

        if(search) {
          search.split('&').forEach(function (part) {
            var parts = part.split('=');
            qs[parts[0]] = parts[1];
          });
        }

        return qs;
      })();

      var appKey = qs.key || localStorage.getItem('app-key'), ta,
          inputKey = document.querySelector('input[type=text]'),
          inputStreet = document.querySelector('input[type=search]'),
          validationMessage = document.querySelector('.validation-message'),
          googleConfig = {
            types: ['address'],
            componentRestrictions: {
              country: 'es'
            }
          },
          messages = {
            number_missing: 'Falta el número de la dirección'
          },
          onPlace = function (place) {
            console.log('place', place);
            // try{ throw new Error(); }catch(err){
            //   console.log('place', place);
            //   console.log('stack', err.stack);
            // }
            document.querySelector('pre.code').innerHTML = place ? JSON.stringify(place, null, '  ') : '---';
          },
          formParams = function (form) {
            if( !(form instanceof Element) && form.length ) form = form[0];

            var data = {};
            [].forEach.call(form.elements, function (el) {
              if( el.name && !el.disabled ) {
                if( el.type === 'radio' ) {
                  if( el.checked ) data[el.name] = el.value;
                } else {
                  data[el.name] = el.value;
                }
              }
            });
            return data;
          };

      inputStreet.value = localStorage.getItem('app-search') || '';

      if( appKey ) {
        ta = new AddressTypeahead('google', appKey, {
          google: googleConfig, messages: messages,
        }).bind('input[type=search]', '.typeahead-wrapper', {
            try_searches: ['nuñez de balboa, 120'],
            custom_address_link: 'Añadir Manualmente',
            getCustomAddress: function (resolve, reject) {
              var form = document.getElementById('custom-address-form'),
                  modal = form.querySelector('.modal'),
                  preventClose = function (e) {
                    e.stopPropagation();
                  },
                  closeForm = function () {
                    modal.removeEventListener('click', preventClose);
                    form.removeEventListener('click', closeForm);
                    form.removeEventListener('submit', onSubmit);
                    form.style.display = 'none';
                  },
                  onSubmit = function (e) {
                    e.preventDefault();
                    var data = formParams(form);
                    data.street_number = Number(data.street_number);
                    console.log('onSubmit', data );
                    resolve(data);
                    closeForm();
                  };
              form.style.display = '';

              modal.addEventListener('click', preventClose);
              form.addEventListener('click', closeForm);
              form.addEventListener('submit', onSubmit);
            }
          })
          .on('place', onPlace)
          .on('change', function (resultAddress, choosed ) {
            this.setAttribute('validation-message', this.validationMessage );
            if( choosed ) validationMessage.textContent = this.validationMessage;
            else validationMessage.textContent = '';

            localStorage.setItem('app-search', this.value);
          });
        inputKey.value = appKey;
      }

      inputKey.addEventListener('input', function () {
        localStorage.setItem('app-key', this.value);
        appKey = this.value;
        if( ta ) ta.unbind();
        ta = new AddressTypeahead('google', appKey, {
          google: googleConfig, messages: messages
        }).bind('input[type=search]', '.typeahead-wrapper').on('place', onPlace);
      });

      // inputStreet.addEventListener('input', function () {
      //   localStorage.setItem('app-search', this.value);
      // });
    </script>
  </body>
</html>
